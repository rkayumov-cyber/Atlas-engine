<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atlas Engine — Block Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', system-ui, sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    .feed { scrollbar-width: thin; scrollbar-color: #334155 transparent; }
    .feed::-webkit-scrollbar { width: 4px; }
    .feed::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
    @keyframes slide-in { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    .slide-in { animation: slide-in 0.25s ease-out; }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .fade-in { animation: fade-in 0.3s ease-out; }
    @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 0 0 rgba(99,102,241,0); } 50% { box-shadow: 0 0 12px 2px rgba(99,102,241,0.15); } }
    .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    .btn { @apply px-3 py-1.5 rounded-lg text-xs font-semibold transition-all duration-150 border cursor-pointer; }
    .btn:active { transform: scale(0.97); }
    .btn-primary { @apply bg-indigo-600 border-indigo-500 hover:bg-indigo-500 text-white; }
    .btn-success { @apply bg-emerald-600/20 border-emerald-500/40 hover:bg-emerald-600/60 text-emerald-400; }
    .btn-warning { @apply bg-amber-600/20 border-amber-500/40 hover:bg-amber-600/60 text-amber-400; }
    .btn-danger { @apply bg-red-600/20 border-red-500/40 hover:bg-red-600/60 text-red-400; }
    .btn-ghost { @apply bg-transparent border-slate-700 hover:bg-slate-800 text-slate-400 hover:text-slate-200; }
    .card { @apply bg-slate-900/60 rounded-xl border border-slate-800/60 p-4; }
    .stat-card { @apply bg-slate-900/60 rounded-xl border border-slate-800/60 px-4 py-3; }
    .input { @apply w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm mono text-slate-200 focus:outline-none focus:border-indigo-500 transition; }
    .modal-backdrop { background: rgba(2,6,23,0.85); backdrop-filter: blur(6px); }
    .nav-item { @apply flex items-center gap-2.5 px-3 py-2 rounded-lg text-sm transition-all duration-150 cursor-pointer; }
    .nav-item:hover { @apply bg-slate-800/60 text-slate-200; }
    .nav-item.active { @apply bg-indigo-600/15 text-indigo-400 border-l-2 border-indigo-500; }
    .section { display: none; }
    .section.active { display: block; }
    .table-row { @apply border-b border-slate-800/40 hover:bg-slate-800/30 transition cursor-pointer; }
    .table-row:last-child { @apply border-b-0; }
    .badge { @apply inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold uppercase tracking-wider; }
    .badge-pow { @apply bg-amber-500/15 text-amber-400 border border-amber-500/30; }
    .badge-pos { @apply bg-emerald-500/15 text-emerald-400 border border-emerald-500/30; }
    .badge-pbft { @apply bg-cyan-500/15 text-cyan-400 border border-cyan-500/30; }
    .tooltip { @apply invisible absolute z-50 px-2 py-1 text-[10px] bg-slate-800 border border-slate-700 rounded text-slate-300 whitespace-nowrap; }
    .has-tooltip:hover .tooltip { @apply visible; }
  </style>
</head>
<body class="bg-slate-950 text-gray-100 min-h-screen overflow-x-hidden">

  <!-- Header -->
  <header class="border-b border-slate-800/60 px-6 py-3 flex items-center justify-between backdrop-blur sticky top-0 z-50 bg-slate-950/90">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center font-bold text-sm">A</div>
      <div>
        <h1 class="text-lg font-bold tracking-tight">Block Explorer</h1>
        <p class="text-xs text-slate-500">Atlas Engine — Chain Inspector</p>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div class="relative">
        <input id="global-search" type="text" placeholder="Search block index, hash, or address..."
          class="w-80 bg-slate-800/80 border border-slate-700/60 rounded-lg pl-9 pr-3 py-2 text-xs mono text-slate-200 focus:outline-none focus:border-indigo-500 transition placeholder:text-slate-600" />
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </div>
      <a href="/" class="btn btn-ghost text-xs">Back to Monitor</a>
      <div class="flex items-center gap-2 text-xs text-slate-400">
        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse" id="conn-dot"></span>
        <span id="connection-status">Connecting...</span>
      </div>
      <span id="clock" class="text-xs text-slate-500 mono"></span>
    </div>
  </header>

  <div class="flex h-[calc(100vh-57px)]">

    <!-- Sidebar Navigation -->
    <nav class="w-56 border-r border-slate-800/40 p-3 flex flex-col gap-1 shrink-0 overflow-y-auto feed">
      <p class="text-[10px] uppercase tracking-wider text-slate-600 px-3 mb-1 mt-1">Explorer</p>
      <div class="nav-item active" data-section="dashboard" onclick="switchSection('dashboard')">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
        Dashboard
      </div>
      <div class="nav-item" data-section="blocks" onclick="switchSection('blocks')">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
        Blocks
      </div>
      <div class="nav-item" data-section="address" onclick="switchSection('address')">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        Address Lookup
      </div>
      <div class="nav-item" data-section="txgraph" onclick="switchSection('txgraph')">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        Transaction Graph
      </div>

      <p class="text-[10px] uppercase tracking-wider text-slate-600 px-3 mb-1 mt-3">Network</p>
      <div class="nav-item" data-section="consensus" onclick="switchSection('consensus')">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
        Consensus
      </div>
      <div class="nav-item" data-section="mempool" onclick="switchSection('mempool')">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
        Mempool
      </div>
      <div class="nav-item" data-section="contracts" onclick="switchSection('contracts')">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
        Contracts
      </div>

      <p class="text-[10px] uppercase tracking-wider text-slate-600 px-3 mb-1 mt-3">Security</p>
      <div class="nav-item" data-section="attacks" onclick="switchSection('attacks')">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
        Attack Simulator
      </div>

      <!-- Spacer -->
      <div class="flex-1"></div>
      <div class="border-t border-slate-800/40 pt-3 mt-2">
        <p class="text-[10px] text-slate-600 px-3">Atlas Engine v2.0</p>
        <p class="text-[10px] text-slate-700 px-3 mt-0.5">Auto-refresh: <span id="refresh-indicator" class="text-emerald-600">5s</span></p>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto feed p-6" id="main-content">

      <!-- ============================================================ -->
      <!-- SECTION: DASHBOARD (Chain Health)                             -->
      <!-- ============================================================ -->
      <div id="section-dashboard" class="section active">
        <div class="flex items-center justify-between mb-5">
          <div>
            <h2 class="text-xl font-bold">Chain Health Dashboard</h2>
            <p class="text-xs text-slate-500 mt-0.5">Real-time blockchain statistics and network health</p>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-[10px] text-slate-500">Last updated:</span>
            <span id="dash-updated" class="text-[10px] mono text-slate-400">--</span>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
          <div class="stat-card pulse-glow">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Total Supply</p>
            <p class="text-2xl font-bold mono text-yellow-400" id="dash-supply">0.0</p>
            <p class="text-[10px] text-slate-600">ATL tokens minted</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">TPS (recent)</p>
            <p class="text-2xl font-bold mono text-pink-400" id="dash-tps">0.00</p>
            <p class="text-[10px] text-slate-600">Transactions per second</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Avg Block Time</p>
            <p class="text-2xl font-bold mono text-cyan-400" id="dash-blocktime">--</p>
            <p class="text-[10px] text-slate-600">Seconds between blocks</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Mempool Size</p>
            <p class="text-2xl font-bold mono text-orange-400" id="dash-mempool">0</p>
            <p class="text-[10px] text-slate-600">Pending transactions</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Fork Status</p>
            <p class="text-lg font-bold" id="dash-forks"><span class="text-emerald-400">No forks</span></p>
            <p class="text-[10px] text-slate-600">Chain integrity</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Consensus Engine</p>
            <p class="text-lg font-bold mono text-indigo-400" id="dash-consensus">--</p>
            <p class="text-[10px] text-slate-600">Current algorithm</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Peer Count</p>
            <p class="text-2xl font-bold mono text-violet-400" id="dash-peers">0</p>
            <p class="text-[10px] text-slate-600">Connected nodes</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Contract Count</p>
            <p class="text-2xl font-bold mono text-emerald-400" id="dash-contracts">0</p>
            <p class="text-[10px] text-slate-600">Deployed smart contracts</p>
          </div>
        </div>

        <!-- Additional Stats Row -->
        <div class="grid grid-cols-3 gap-3 mb-6">
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Chain Length</p>
            <p class="text-2xl font-bold mono text-indigo-400" id="dash-chain-len">0</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Total Transactions</p>
            <p class="text-2xl font-bold mono text-amber-400" id="dash-total-txs">0</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Unique Addresses</p>
            <p class="text-2xl font-bold mono text-teal-400" id="dash-addresses">0</p>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
          <h3 class="text-sm font-bold mb-3">Recent Block Activity</h3>
          <div class="flex items-end gap-[3px] h-20" id="dash-sparkline">
            <span class="text-[10px] text-slate-600">Loading...</span>
          </div>
          <p class="text-[10px] text-slate-600 mt-2">Transaction count per block (last 30 blocks)</p>
        </div>
      </div>

      <!-- ============================================================ -->
      <!-- SECTION: BLOCKS                                               -->
      <!-- ============================================================ -->
      <div id="section-blocks" class="section">
        <div class="flex items-center justify-between mb-5">
          <div>
            <h2 class="text-xl font-bold">Recent Blocks</h2>
            <p class="text-xs text-slate-500 mt-0.5">Latest 20 blocks on the chain</p>
          </div>
          <button onclick="loadBlocks()" class="btn btn-ghost">Refresh</button>
        </div>

        <div class="card overflow-hidden">
          <table class="w-full text-xs">
            <thead>
              <tr class="border-b border-slate-800/60">
                <th class="text-left text-[10px] uppercase tracking-wider text-slate-500 pb-2 px-3">Index</th>
                <th class="text-left text-[10px] uppercase tracking-wider text-slate-500 pb-2 px-3">Timestamp</th>
                <th class="text-left text-[10px] uppercase tracking-wider text-slate-500 pb-2 px-3">TXs</th>
                <th class="text-left text-[10px] uppercase tracking-wider text-slate-500 pb-2 px-3">Consensus</th>
                <th class="text-left text-[10px] uppercase tracking-wider text-slate-500 pb-2 px-3">Merkle Root</th>
                <th class="text-left text-[10px] uppercase tracking-wider text-slate-500 pb-2 px-3">Proof</th>
              </tr>
            </thead>
            <tbody id="blocks-table">
              <tr><td colspan="6" class="text-center text-slate-600 py-8">Loading blocks...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Block Detail Panel -->
        <div id="block-detail-panel" class="card mt-4 hidden">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-bold">Block Details</h3>
            <button onclick="document.getElementById('block-detail-panel').classList.add('hidden')" class="text-slate-500 hover:text-slate-300 text-lg">&times;</button>
          </div>
          <div id="block-detail-content"></div>
        </div>
      </div>

      <!-- ============================================================ -->
      <!-- SECTION: ADDRESS LOOKUP                                       -->
      <!-- ============================================================ -->
      <div id="section-address" class="section">
        <div class="flex items-center justify-between mb-5">
          <div>
            <h2 class="text-xl font-bold">Address Lookup</h2>
            <p class="text-xs text-slate-500 mt-0.5">Inspect balance, stake, and transaction history for any address</p>
          </div>
        </div>

        <div class="card mb-4">
          <div class="flex gap-3">
            <input id="addr-input" type="text" placeholder="Enter wallet address..." class="input flex-1" />
            <button onclick="lookupAddress()" class="btn btn-primary">Lookup</button>
          </div>
        </div>

        <div id="addr-result" class="hidden">
          <!-- Balance Card -->
          <div class="grid grid-cols-3 gap-3 mb-4">
            <div class="stat-card">
              <p class="text-[10px] uppercase tracking-wider text-slate-500">Balance</p>
              <p class="text-2xl font-bold mono text-emerald-400" id="addr-balance">0.0</p>
              <p class="text-[10px] text-slate-600">ATL</p>
            </div>
            <div class="stat-card">
              <p class="text-[10px] uppercase tracking-wider text-slate-500">Nonce</p>
              <p class="text-2xl font-bold mono text-slate-300" id="addr-nonce">0</p>
              <p class="text-[10px] text-slate-600">Transaction count</p>
            </div>
            <div class="stat-card">
              <p class="text-[10px] uppercase tracking-wider text-slate-500">Stake</p>
              <p class="text-2xl font-bold mono text-violet-400" id="addr-stake">0.0</p>
              <p class="text-[10px] text-slate-600">ATL staked</p>
            </div>
          </div>

          <!-- QR Code -->
          <div class="flex gap-4 mb-4">
            <div class="card flex-1">
              <p class="text-[10px] uppercase tracking-wider text-slate-500 mb-2">Address</p>
              <p class="text-xs mono text-slate-300 break-all" id="addr-display"></p>
            </div>
            <div class="card flex-shrink-0 flex items-center justify-center" id="addr-qr" style="width:120px;height:120px;">
            </div>
          </div>

          <!-- Transaction History -->
          <div class="card">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-bold">Transaction History</h3>
              <div class="flex items-center gap-2">
                <button onclick="exportAddressCSV()" class="btn btn-ghost text-[10px]">
                  <span class="flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Export CSV
                  </span>
                </button>
              </div>
            </div>
            <div id="addr-tx-list" class="space-y-2">
              <p class="text-xs text-slate-600 text-center py-4">No transactions found</p>
            </div>
            <!-- Pagination -->
            <div class="flex items-center justify-between mt-4 pt-3 border-t border-slate-800/40">
              <p class="text-[10px] text-slate-500">Showing <span id="addr-tx-showing">0</span> of <span id="addr-tx-total">0</span></p>
              <div class="flex gap-2">
                <button id="addr-prev-btn" onclick="addrPagePrev()" class="btn btn-ghost text-[10px]" disabled>Previous</button>
                <button id="addr-next-btn" onclick="addrPageNext()" class="btn btn-ghost text-[10px]" disabled>Next</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================================ -->
      <!-- SECTION: TRANSACTION GRAPH                                    -->
      <!-- ============================================================ -->
      <div id="section-txgraph" class="section">
        <div class="flex items-center justify-between mb-5">
          <div>
            <h2 class="text-xl font-bold">Transaction Graph</h2>
            <p class="text-xs text-slate-500 mt-0.5">Visual map of token flow between top addresses</p>
          </div>
          <button onclick="buildTxGraph()" class="btn btn-primary">Rebuild Graph</button>
        </div>

        <div class="card" style="min-height: 500px;">
          <svg id="tx-graph-svg" width="100%" height="500" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                <polygon points="0 0, 8 3, 0 6" fill="#6366f1" opacity="0.7"/>
              </marker>
              <filter id="node-glow"><feGaussianBlur stdDeviation="3" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
            </defs>
            <g id="graph-edges"></g>
            <g id="graph-nodes"></g>
            <text x="50%" y="50%" text-anchor="middle" fill="#475569" font-size="13">Click "Rebuild Graph" to visualize</text>
          </svg>
          <div class="mt-3 flex gap-4 text-[10px] text-slate-500">
            <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-indigo-500"></span> Address node (size = balance)</div>
            <div class="flex items-center gap-1.5"><span class="w-6 h-0.5 bg-indigo-500 rounded"></span> Transaction flow (thickness = volume)</div>
            <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-amber-500"></span> Mining reward recipient</div>
          </div>
        </div>
      </div>

      <!-- ============================================================ -->
      <!-- SECTION: CONSENSUS COMPARISON                                 -->
      <!-- ============================================================ -->
      <div id="section-consensus" class="section">
        <div class="flex items-center justify-between mb-5">
          <div>
            <h2 class="text-xl font-bold">Consensus Comparison Panel</h2>
            <p class="text-xs text-slate-500 mt-0.5">Inspect and switch consensus engines</p>
          </div>
          <button onclick="loadConsensusInfo()" class="btn btn-ghost">Refresh</button>
        </div>

        <!-- Current Engine Info -->
        <div class="card mb-4">
          <h3 class="text-sm font-bold mb-3">Current Consensus Engine</h3>
          <div id="consensus-detail" class="space-y-2">
            <p class="text-xs text-slate-600">Loading...</p>
          </div>
        </div>

        <!-- Switch Buttons -->
        <div class="grid grid-cols-3 gap-3 mb-4">
          <div class="card hover:border-amber-500/40 transition cursor-pointer" onclick="switchConsensus('pow')">
            <div class="flex items-center gap-2 mb-2">
              <span class="badge badge-pow">PoW</span>
              <h4 class="text-sm font-semibold">Proof of Work</h4>
            </div>
            <p class="text-[10px] text-slate-500 mb-3">CPU-intensive mining. Security through computational cost. Classic Nakamoto consensus.</p>
            <div class="flex items-center gap-2">
              <label class="text-[10px] text-slate-500">Difficulty:</label>
              <input id="pow-difficulty" type="number" min="1" max="8" value="4" class="w-16 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-[10px] mono text-slate-300 focus:outline-none" />
            </div>
            <button class="btn btn-warning w-full mt-3">Switch to PoW</button>
          </div>

          <div class="card hover:border-emerald-500/40 transition cursor-pointer" onclick="switchConsensus('pos')">
            <div class="flex items-center gap-2 mb-2">
              <span class="badge badge-pos">PoS</span>
              <h4 class="text-sm font-semibold">Proof of Stake</h4>
            </div>
            <p class="text-[10px] text-slate-500 mb-3">Energy-efficient. Validators selected by stake weight. No mining required.</p>
            <div class="flex items-center gap-2">
              <label class="text-[10px] text-slate-500">Min Stake:</label>
              <input id="pos-min-stake" type="number" min="1" value="10" class="w-16 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-[10px] mono text-slate-300 focus:outline-none" />
            </div>
            <button class="btn btn-success w-full mt-3">Switch to PoS</button>
          </div>

          <div class="card hover:border-cyan-500/40 transition cursor-pointer" onclick="switchConsensus('pbft')">
            <div class="flex items-center gap-2 mb-2">
              <span class="badge badge-pbft">PBFT</span>
              <h4 class="text-sm font-semibold">PBFT</h4>
            </div>
            <p class="text-[10px] text-slate-500 mb-3">Byzantine fault tolerant. Fast finality. Tolerates up to f = (n-1)/3 faulty nodes.</p>
            <div class="flex items-center gap-2">
              <label class="text-[10px] text-slate-500">Total Nodes:</label>
              <input id="pbft-nodes" type="number" min="4" value="31" class="w-16 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-[10px] mono text-slate-300 focus:outline-none" />
            </div>
            <button class="btn btn-primary w-full mt-3">Switch to PBFT</button>
          </div>
        </div>

        <!-- Switch Result -->
        <div id="consensus-switch-result" class="card hidden">
          <div id="consensus-switch-content"></div>
        </div>

        <!-- Stakes Info -->
        <div class="card">
          <h3 class="text-sm font-bold mb-3">Current Stakes</h3>
          <div id="stakes-list" class="space-y-2">
            <p class="text-xs text-slate-600 text-center py-4">Loading stakes...</p>
          </div>
        </div>
      </div>

      <!-- ============================================================ -->
      <!-- SECTION: MEMPOOL                                              -->
      <!-- ============================================================ -->
      <div id="section-mempool" class="section">
        <div class="flex items-center justify-between mb-5">
          <div>
            <h2 class="text-xl font-bold">Mempool Viewer</h2>
            <p class="text-xs text-slate-500 mt-0.5">Pending transactions waiting to be mined</p>
          </div>
          <button onclick="loadMempool()" class="btn btn-ghost">Refresh</button>
        </div>

        <!-- Mempool Stats -->
        <div class="grid grid-cols-4 gap-3 mb-4">
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Pending TXs</p>
            <p class="text-2xl font-bold mono text-orange-400" id="mp-count">0</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Total Value</p>
            <p class="text-2xl font-bold mono text-emerald-400" id="mp-value">0.0</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Total Fees</p>
            <p class="text-2xl font-bold mono text-amber-400" id="mp-fees">0.0</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] uppercase tracking-wider text-slate-500">Oldest TX Age</p>
            <p class="text-2xl font-bold mono text-slate-300" id="mp-oldest">--</p>
          </div>
        </div>

        <!-- Pending Transactions -->
        <div class="card">
          <h3 class="text-sm font-bold mb-3">Pending Transactions (sorted by fee)</h3>
          <div id="mempool-list" class="space-y-2">
            <p class="text-xs text-slate-600 text-center py-8">Loading mempool...</p>
          </div>
        </div>
      </div>

      <!-- ============================================================ -->
      <!-- SECTION: CONTRACTS                                            -->
      <!-- ============================================================ -->
      <div id="section-contracts" class="section">
        <div class="flex items-center justify-between mb-5">
          <div>
            <h2 class="text-xl font-bold">Contract Explorer</h2>
            <p class="text-xs text-slate-500 mt-0.5">Deployed smart contracts and templates</p>
          </div>
          <button onclick="loadContracts()" class="btn btn-ghost">Refresh</button>
        </div>

        <!-- Contract List -->
        <div class="card mb-4">
          <h3 class="text-sm font-bold mb-3">Deployed Contracts</h3>
          <div id="contract-list" class="space-y-2">
            <p class="text-xs text-slate-600 text-center py-8">Loading contracts...</p>
          </div>
        </div>

        <!-- Contract Detail -->
        <div id="contract-detail-panel" class="card hidden mb-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-bold">Contract Details</h3>
            <button onclick="document.getElementById('contract-detail-panel').classList.add('hidden')" class="text-slate-500 hover:text-slate-300 text-lg">&times;</button>
          </div>
          <div id="contract-detail-content"></div>
        </div>

        <!-- Templates -->
        <div class="card">
          <h3 class="text-sm font-bold mb-3">Available Templates</h3>
          <div id="template-list" class="space-y-2">
            <p class="text-xs text-slate-600 text-center py-4">Loading templates...</p>
          </div>
        </div>
      </div>

      <!-- ============================================================ -->
      <!-- SECTION: ATTACK SIMULATOR                                     -->
      <!-- ============================================================ -->
      <div id="section-attacks" class="section">
        <div class="flex items-center justify-between mb-5">
          <div>
            <h2 class="text-xl font-bold">Attack Simulation Panel</h2>
            <p class="text-xs text-slate-500 mt-0.5">Educational simulations of blockchain attack vectors</p>
          </div>
          <span class="badge bg-red-500/10 text-red-400 border border-red-500/30">Educational Only</span>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <!-- Double Spend -->
          <div class="card">
            <div class="flex items-center gap-2 mb-3">
              <svg class="w-5 h-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <h3 class="text-sm font-bold">Double Spend Attack</h3>
            </div>
            <p class="text-[10px] text-slate-500 mb-3">Attempt to spend the same tokens twice by sending to two different recipients simultaneously.</p>
            <div class="space-y-2 mb-3">
              <input id="ds-address" type="text" placeholder="Attacker address" class="input text-[10px]" />
              <input id="ds-amount" type="number" value="5" min="1" placeholder="Amount" class="input text-[10px]" />
              <input id="ds-recipient1" type="text" placeholder="Recipient 1 (optional)" class="input text-[10px]" />
              <input id="ds-recipient2" type="text" placeholder="Recipient 2 (optional)" class="input text-[10px]" />
            </div>
            <button onclick="simDoubleSpend()" class="btn btn-danger w-full">Run Double Spend</button>
            <div id="ds-result" class="mt-3 text-xs"></div>
          </div>

          <!-- 51% Attack -->
          <div class="card">
            <div class="flex items-center gap-2 mb-3">
              <svg class="w-5 h-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
              <h3 class="text-sm font-bold">51% Attack</h3>
            </div>
            <p class="text-[10px] text-slate-500 mb-3">Simulate an attacker with majority hash power creating an alternative chain to override the honest chain.</p>
            <div class="space-y-2 mb-3">
              <div class="flex items-center gap-2">
                <label class="text-[10px] text-slate-500 whitespace-nowrap">Malicious blocks:</label>
                <input id="a51-blocks" type="number" value="3" min="1" max="20" class="input text-[10px]" />
              </div>
            </div>
            <button onclick="sim51Attack()" class="btn btn-danger w-full">Run 51% Attack</button>
            <div id="a51-result" class="mt-3 text-xs"></div>
          </div>

          <!-- Selfish Mining -->
          <div class="card">
            <div class="flex items-center gap-2 mb-3">
              <svg class="w-5 h-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
              <h3 class="text-sm font-bold">Selfish Mining</h3>
            </div>
            <p class="text-[10px] text-slate-500 mb-3">Simulate a selfish miner who withholds found blocks and strategically releases them to gain advantage.</p>
            <div class="space-y-2 mb-3">
              <div class="flex items-center gap-2">
                <label class="text-[10px] text-slate-500 whitespace-nowrap">Rounds:</label>
                <input id="sm-rounds" type="number" value="100" min="1" max="10000" class="input text-[10px]" />
              </div>
              <div class="flex items-center gap-2">
                <label class="text-[10px] text-slate-500 whitespace-nowrap">Hash power:</label>
                <input id="sm-power" type="number" value="0.3" min="0.01" max="0.99" step="0.01" class="input text-[10px]" />
              </div>
            </div>
            <button onclick="simSelfishMining()" class="btn btn-warning w-full">Run Selfish Mining</button>
            <div id="sm-result" class="mt-3 text-xs"></div>
          </div>

          <!-- Step-through Mining -->
          <div class="card">
            <div class="flex items-center gap-2 mb-3">
              <svg class="w-5 h-5 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <h3 class="text-sm font-bold">Step-Through Mining</h3>
            </div>
            <p class="text-[10px] text-slate-500 mb-3">Watch the mining process step by step. See each hash attempt and whether it meets the difficulty target.</p>
            <div class="space-y-2 mb-3">
              <div class="flex items-center gap-2">
                <label class="text-[10px] text-slate-500 whitespace-nowrap">Max steps:</label>
                <input id="step-steps" type="number" value="100" min="1" max="10000" class="input text-[10px]" />
              </div>
            </div>
            <button onclick="simStepMine()" class="btn btn-primary w-full">Run Step Mining</button>
            <div id="step-result" class="mt-3 text-xs max-h-60 overflow-y-auto feed"></div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    // =======================================================================
    // CONFIG & STATE
    // =======================================================================
    const API_BASE = '';  // same origin
    let chainData = [];
    let statsData = {};
    let addrPage = { offset: 0, limit: 20, total: 0, address: '' };
    let tpsHistory = [];

    // =======================================================================
    // UTILITIES
    // =======================================================================
    function truncAddr(a, n = 8) {
      if (!a) return '???';
      if (a.length <= n * 2 + 2) return a;
      return a.slice(0, n) + '..' + a.slice(-4);
    }

    function fmtTime(ts) {
      if (!ts) return '--';
      const d = new Date(ts * 1000);
      return d.toLocaleString();
    }

    function fmtAgo(ts) {
      const diff = Date.now() / 1000 - ts;
      if (diff < 60) return `${Math.floor(diff)}s ago`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      return `${Math.floor(diff / 3600)}h ago`;
    }

    async function apiFetch(path, opts = {}) {
      try {
        const res = await fetch(`${API_BASE}${path}`, { signal: AbortSignal.timeout(10000), ...opts });
        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: res.statusText }));
          throw new Error(err.error || res.statusText);
        }
        return await res.json();
      } catch (e) {
        console.error(`API ${path}:`, e);
        throw e;
      }
    }

    async function apiPost(path, body) {
      return apiFetch(path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
    }

    function escHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // =======================================================================
    // CLOCK
    // =======================================================================
    setInterval(() => {
      document.getElementById('clock').textContent = new Date().toLocaleTimeString();
    }, 1000);

    // =======================================================================
    // NAVIGATION
    // =======================================================================
    function switchSection(name) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      const section = document.getElementById(`section-${name}`);
      if (section) section.classList.add('active');
      const navItem = document.querySelector(`.nav-item[data-section="${name}"]`);
      if (navItem) navItem.classList.add('active');

      // Load section data
      switch (name) {
        case 'dashboard': loadDashboard(); break;
        case 'blocks': loadBlocks(); break;
        case 'consensus': loadConsensusInfo(); loadStakes(); break;
        case 'mempool': loadMempool(); break;
        case 'contracts': loadContracts(); loadTemplates(); break;
        case 'txgraph': break;
        case 'attacks': break;
      }
    }

    // =======================================================================
    // GLOBAL SEARCH
    // =======================================================================
    document.getElementById('global-search').addEventListener('keydown', async function(e) {
      if (e.key !== 'Enter') return;
      const q = this.value.trim();
      if (!q) return;

      // Try block index
      if (/^\d+$/.test(q)) {
        switchSection('blocks');
        await loadBlocks();
        showBlockDetail(parseInt(q));
        return;
      }

      // Try block hash (64 char hex)
      if (/^[a-fA-F0-9]{64}$/.test(q)) {
        try {
          const block = await apiFetch(`/block/hash/${q}`);
          switchSection('blocks');
          await loadBlocks();
          showBlockDetail(block.index);
          return;
        } catch {
          // Not a block hash, try as address
        }
      }

      // Default: address lookup
      document.getElementById('addr-input').value = q;
      switchSection('address');
      lookupAddress();
    });

    // =======================================================================
    // DASHBOARD
    // =======================================================================
    async function loadDashboard() {
      try {
        const [stats, chain, consensus, mempool, forks, contracts] = await Promise.all([
          apiFetch('/stats').catch(() => ({})),
          apiFetch('/chain').catch(() => ({ chain: [], length: 0 })),
          apiFetch('/consensus').catch(() => ({})),
          apiFetch('/mempool').catch(() => ({ size: 0 })),
          apiFetch('/forks').catch(() => ({ forks_detected: false })),
          apiFetch('/contracts').catch(() => ({ contracts: [] })),
        ]);

        statsData = stats;
        chainData = chain.chain || [];

        document.getElementById('dash-supply').textContent = (stats.total_supply ?? 0).toFixed(1);
        document.getElementById('dash-chain-len').textContent = chain.length ?? chainData.length;
        document.getElementById('dash-total-txs').textContent = stats.total_transactions ?? 0;
        document.getElementById('dash-addresses').textContent = stats.circulating_addresses ?? 0;
        document.getElementById('dash-consensus').textContent = (consensus.name || consensus.engine || '--').toUpperCase();
        document.getElementById('dash-mempool').textContent = mempool.size ?? 0;
        document.getElementById('dash-peers').textContent = stats.peers ?? 0;
        document.getElementById('dash-contracts').textContent = (contracts.contracts || []).length;

        // TPS calculation
        tpsHistory.push({ time: Date.now(), txs: stats.total_transactions ?? 0 });
        if (tpsHistory.length > 1) {
          const recent = tpsHistory.slice(-10);
          const dt = (recent[recent.length - 1].time - recent[0].time) / 1000;
          const dc = recent[recent.length - 1].txs - recent[0].txs;
          document.getElementById('dash-tps').textContent = dt > 0 ? (dc / dt).toFixed(2) : '0.00';
        }
        while (tpsHistory.length > 60) tpsHistory.shift();

        // Avg block time
        if (chainData.length >= 2) {
          const recent = chainData.slice(-20);
          let diffs = [];
          for (let i = 1; i < recent.length; i++) {
            const d = recent[i].timestamp - recent[i - 1].timestamp;
            if (d > 0) diffs.push(d);
          }
          if (diffs.length > 0) {
            const avg = diffs.reduce((a, b) => a + b, 0) / diffs.length;
            document.getElementById('dash-blocktime').textContent = avg.toFixed(1) + 's';
          }
        }

        // Fork status
        const forkEl = document.getElementById('dash-forks');
        if (forks.forks_detected) {
          forkEl.innerHTML = '<span class="text-red-400">Fork detected!</span>';
        } else {
          forkEl.innerHTML = '<span class="text-emerald-400">No forks</span>';
        }

        // Sparkline
        renderDashSparkline();

        // Connection status
        document.getElementById('conn-dot').className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
        document.getElementById('connection-status').textContent = 'Connected';
        document.getElementById('dash-updated').textContent = new Date().toLocaleTimeString();
      } catch (e) {
        document.getElementById('conn-dot').className = 'w-2 h-2 rounded-full bg-red-500';
        document.getElementById('connection-status').textContent = 'Disconnected';
      }
    }

    function renderDashSparkline() {
      const el = document.getElementById('dash-sparkline');
      const blocks = chainData.slice(-30);
      if (blocks.length === 0) { el.innerHTML = '<span class="text-[10px] text-slate-600">No blocks yet</span>'; return; }
      const data = blocks.map(b => (b.transactions || []).length);
      const max = Math.max(...data, 1);
      el.innerHTML = data.map((v, i) => {
        const h = Math.max(3, (v / max) * 72);
        const color = v > 0 ? 'bg-indigo-500/80 hover:bg-indigo-400' : 'bg-slate-800';
        return `<div class="flex-1 ${color} rounded-sm transition-all cursor-pointer has-tooltip relative" style="height:${h}px" title="Block #${blocks[i].index}: ${v} tx(s)">
          <div class="tooltip -top-8 left-1/2 -translate-x-1/2">Block #${blocks[i].index}: ${v} tx</div>
        </div>`;
      }).join('');
    }

    // =======================================================================
    // BLOCKS
    // =======================================================================
    async function loadBlocks() {
      try {
        const data = await apiFetch('/chain');
        chainData = data.chain || [];
        const recent = chainData.slice(-20).reverse();
        const tbody = document.getElementById('blocks-table');

        if (recent.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-slate-600 py-8">No blocks found</td></tr>';
          return;
        }

        tbody.innerHTML = recent.map(b => {
          const consensusType = b.consensus || 'pow';
          const badgeClass = consensusType === 'pos' ? 'badge-pos' : consensusType === 'pbft' ? 'badge-pbft' : 'badge-pow';
          const merkle = b.merkle_root || '--';
          return `
            <tr class="table-row" onclick="showBlockDetail(${b.index})">
              <td class="px-3 py-2.5"><span class="mono text-indigo-400 font-semibold">#${b.index}</span></td>
              <td class="px-3 py-2.5 text-slate-400">${fmtTime(b.timestamp)}</td>
              <td class="px-3 py-2.5"><span class="mono text-amber-400">${(b.transactions || []).length}</span></td>
              <td class="px-3 py-2.5"><span class="badge ${badgeClass}">${escHtml(consensusType)}</span></td>
              <td class="px-3 py-2.5 mono text-slate-500 text-[10px]">${merkle === '--' ? '--' : escHtml(merkle.slice(0, 16)) + '...'}</td>
              <td class="px-3 py-2.5 mono text-cyan-400">${b.proof ?? '--'}</td>
            </tr>`;
        }).join('');
      } catch (e) {
        document.getElementById('blocks-table').innerHTML =
          `<tr><td colspan="6" class="text-center text-red-400 py-8">Error loading blocks: ${escHtml(e.message)}</td></tr>`;
      }
    }

    async function showBlockDetail(index) {
      const panel = document.getElementById('block-detail-panel');
      const content = document.getElementById('block-detail-content');
      panel.classList.remove('hidden');
      content.innerHTML = '<p class="text-xs text-slate-500">Loading block...</p>';

      try {
        const block = await apiFetch(`/block/${index}`);
        const merkleInfo = await apiFetch(`/block/${index}/merkle`).catch(() => null);

        content.innerHTML = `
          <div class="space-y-4 fade-in">
            <div class="grid grid-cols-3 gap-3">
              <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
                <p class="text-[10px] text-slate-500 uppercase">Block Index</p>
                <p class="text-xl font-bold mono text-indigo-400">#${block.index}</p>
              </div>
              <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
                <p class="text-[10px] text-slate-500 uppercase">Proof</p>
                <p class="text-xl font-bold mono text-cyan-400">${block.proof ?? '--'}</p>
              </div>
              <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
                <p class="text-[10px] text-slate-500 uppercase">Transactions</p>
                <p class="text-xl font-bold mono text-amber-400">${block.tx_count ?? (block.transactions || []).length}</p>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
                <p class="text-[10px] text-slate-500 uppercase mb-1">Timestamp</p>
                <p class="text-xs mono text-slate-300">${fmtTime(block.timestamp)}</p>
              </div>
              <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
                <p class="text-[10px] text-slate-500 uppercase mb-1">Consensus</p>
                <p class="text-xs mono text-slate-300">${escHtml(block.consensus || 'pow')}</p>
              </div>
            </div>

            <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
              <p class="text-[10px] text-slate-500 uppercase mb-1">Block Hash</p>
              <p class="text-[10px] mono text-slate-300 break-all">${escHtml(block.hash || '--')}</p>
            </div>

            <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
              <p class="text-[10px] text-slate-500 uppercase mb-1">Previous Hash</p>
              <p class="text-[10px] mono text-slate-300 break-all">${escHtml(block.previous_hash || '--')}</p>
            </div>

            <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
              <p class="text-[10px] text-slate-500 uppercase mb-1">Merkle Root</p>
              <p class="text-[10px] mono text-emerald-400 break-all">${escHtml(block.merkle_root || '--')}</p>
              ${merkleInfo ? `<p class="text-[10px] text-slate-600 mt-1">Tree depth: ${merkleInfo.tree_depth}, Leaves: ${merkleInfo.leaf_count}</p>` : ''}
            </div>

            ${block.mining_time ? `
            <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
              <p class="text-[10px] text-slate-500 uppercase mb-1">Mining Time</p>
              <p class="text-xs mono text-pink-400">${block.mining_time.toFixed(4)}s</p>
            </div>` : ''}

            <div>
              <p class="text-[10px] text-slate-500 uppercase mb-2">Transactions (${(block.transactions || []).length})</p>
              ${(block.transactions || []).length === 0 ? '<p class="text-xs text-slate-600">No transactions in this block</p>' :
                (block.transactions || []).map((tx, ti) => `
                  <div class="bg-slate-800/40 rounded-lg p-3 border border-slate-800 mb-2">
                    <div class="flex items-center justify-between mb-1.5">
                      <span class="text-[10px] uppercase font-semibold ${tx.sender === 'MINING_REWARD' ? 'text-emerald-500' : 'text-amber-500'}">${tx.sender === 'MINING_REWARD' ? 'Coinbase Reward' : 'Transfer'}</span>
                      <span class="text-sm font-bold mono ${tx.sender === 'MINING_REWARD' ? 'text-emerald-400' : 'text-amber-400'}">${tx.amount} ATL</span>
                    </div>
                    <p class="text-[10px] mono text-slate-500">From: <span class="text-slate-400 cursor-pointer hover:text-indigo-400" onclick="event.stopPropagation(); searchAddress('${escHtml(tx.sender)}')">${tx.sender === 'MINING_REWARD' ? 'COINBASE' : escHtml(tx.sender)}</span></p>
                    <p class="text-[10px] mono text-slate-500">To: <span class="text-slate-300 cursor-pointer hover:text-indigo-400" onclick="event.stopPropagation(); searchAddress('${escHtml(tx.recipient)}')">${escHtml(tx.recipient)}</span></p>
                    ${tx.fee ? `<p class="text-[10px] mono text-slate-600">Fee: ${tx.fee} ATL</p>` : ''}
                    ${tx.signature ? `<p class="text-[10px] mono text-slate-700 truncate mt-1">Sig: ${escHtml(tx.signature.slice(0, 40))}...</p>` : ''}
                    ${merkleInfo ? `<button onclick="event.stopPropagation(); showMerkleProof(${block.index}, ${ti})" class="text-[10px] text-indigo-400 hover:text-indigo-300 mt-1">View Merkle Proof</button>` : ''}
                  </div>
                `).join('')
              }
            </div>
          </div>`;

        // Scroll to detail
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } catch (e) {
        content.innerHTML = `<p class="text-xs text-red-400">Error loading block: ${escHtml(e.message)}</p>`;
      }
    }

    async function showMerkleProof(blockIndex, txIndex) {
      try {
        const proof = await apiFetch(`/block/${blockIndex}/merkle?tx_index=${txIndex}`);
        alert(`Merkle Proof for TX #${txIndex} in Block #${blockIndex}:\n\nRoot: ${proof.merkle_root}\nTree Depth: ${proof.tree_depth}\nProof: ${JSON.stringify(proof.proof, null, 2)}`);
      } catch (e) {
        alert(`Error: ${e.message}`);
      }
    }

    function searchAddress(addr) {
      if (addr === 'MINING_REWARD' || addr === 'COINBASE') return;
      document.getElementById('addr-input').value = addr;
      switchSection('address');
      lookupAddress();
    }

    // =======================================================================
    // ADDRESS LOOKUP
    // =======================================================================
    async function lookupAddress() {
      const addr = document.getElementById('addr-input').value.trim();
      if (!addr) return;
      addrPage.address = addr;
      addrPage.offset = 0;

      const resultEl = document.getElementById('addr-result');
      resultEl.classList.remove('hidden');

      try {
        const [balance, history] = await Promise.all([
          apiFetch(`/balance/${encodeURIComponent(addr)}`),
          apiFetch(`/history/${encodeURIComponent(addr)}?limit=${addrPage.limit}&offset=0`),
        ]);

        document.getElementById('addr-balance').textContent = (balance.balance ?? 0).toFixed(4);
        document.getElementById('addr-nonce').textContent = balance.nonce ?? 0;
        document.getElementById('addr-stake').textContent = (balance.stake ?? 0).toFixed(4);
        document.getElementById('addr-display').textContent = addr;

        // QR Code
        const qrEl = document.getElementById('addr-qr');
        try {
          const qrRes = await fetch(`/qr/${encodeURIComponent(addr)}`);
          const qrSvg = await qrRes.text();
          qrEl.innerHTML = qrSvg;
          const svg = qrEl.querySelector('svg');
          if (svg) { svg.setAttribute('width', '100'); svg.setAttribute('height', '100'); }
        } catch { qrEl.innerHTML = '<p class="text-[10px] text-slate-600">QR unavailable</p>'; }

        // Transactions
        addrPage.total = history.total ?? 0;
        renderAddrTxs(history.transactions || []);
        updateAddrPagination();
      } catch (e) {
        resultEl.innerHTML = `<div class="card"><p class="text-red-400 text-xs">Error: ${escHtml(e.message)}</p></div>`;
      }
    }

    function renderAddrTxs(txs) {
      const el = document.getElementById('addr-tx-list');
      if (txs.length === 0) {
        el.innerHTML = '<p class="text-xs text-slate-600 text-center py-4">No transactions found</p>';
        return;
      }
      el.innerHTML = txs.map(tx => {
        const isIncoming = tx.direction === 'in' || tx.recipient === addrPage.address;
        return `
          <div class="bg-slate-800/40 rounded-lg p-3 border border-slate-800/60 slide-in">
            <div class="flex items-center justify-between mb-1">
              <div class="flex items-center gap-2">
                <span class="text-[10px] uppercase font-semibold ${isIncoming ? 'text-emerald-500' : 'text-red-400'}">${isIncoming ? 'Received' : 'Sent'}</span>
                ${tx.block_index !== undefined ? `<span class="text-[10px] text-slate-600">Block #${tx.block_index}</span>` : ''}
              </div>
              <span class="text-sm font-bold mono ${isIncoming ? 'text-emerald-400' : 'text-red-400'}">${isIncoming ? '+' : '-'}${tx.amount} ATL</span>
            </div>
            <p class="text-[10px] mono text-slate-500">From: ${escHtml(tx.sender === 'MINING_REWARD' ? 'COINBASE' : (tx.sender || ''))}</p>
            <p class="text-[10px] mono text-slate-400">To: ${escHtml(tx.recipient || '')}</p>
            ${tx.fee ? `<p class="text-[10px] mono text-slate-600">Fee: ${tx.fee} ATL</p>` : ''}
            ${tx.timestamp ? `<p class="text-[10px] text-slate-600 mt-1">${fmtTime(tx.timestamp)}</p>` : ''}
          </div>`;
      }).join('');
    }

    function updateAddrPagination() {
      const showing = Math.min(addrPage.offset + addrPage.limit, addrPage.total);
      document.getElementById('addr-tx-showing').textContent = `${addrPage.offset + 1}-${showing}`;
      document.getElementById('addr-tx-total').textContent = addrPage.total;
      document.getElementById('addr-prev-btn').disabled = addrPage.offset <= 0;
      document.getElementById('addr-next-btn').disabled = addrPage.offset + addrPage.limit >= addrPage.total;
    }

    async function addrPageNext() {
      addrPage.offset += addrPage.limit;
      try {
        const history = await apiFetch(`/history/${encodeURIComponent(addrPage.address)}?limit=${addrPage.limit}&offset=${addrPage.offset}`);
        renderAddrTxs(history.transactions || []);
        updateAddrPagination();
      } catch (e) { console.error(e); }
    }

    async function addrPagePrev() {
      addrPage.offset = Math.max(0, addrPage.offset - addrPage.limit);
      try {
        const history = await apiFetch(`/history/${encodeURIComponent(addrPage.address)}?limit=${addrPage.limit}&offset=${addrPage.offset}`);
        renderAddrTxs(history.transactions || []);
        updateAddrPagination();
      } catch (e) { console.error(e); }
    }

    function exportAddressCSV() {
      if (!addrPage.address) return;
      window.open(`/history/${encodeURIComponent(addrPage.address)}?format=csv&limit=500`, '_blank');
    }

    // =======================================================================
    // TRANSACTION GRAPH
    // =======================================================================
    async function buildTxGraph() {
      try {
        const data = await apiFetch('/chain');
        const chain = data.chain || [];

        // Build address map
        const addrMap = {};   // address -> { balance, isMiner }
        const edgeMap = {};   // "from->to" -> total amount

        for (const block of chain) {
          for (const tx of (block.transactions || [])) {
            const sender = tx.sender || '';
            const recipient = tx.recipient || '';
            if (recipient) {
              if (!addrMap[recipient]) addrMap[recipient] = { balance: 0, isMiner: false };
              addrMap[recipient].balance += tx.amount;
              if (sender === 'MINING_REWARD') addrMap[recipient].isMiner = true;
            }
            if (sender && sender !== 'MINING_REWARD') {
              if (!addrMap[sender]) addrMap[sender] = { balance: 0, isMiner: false };
              addrMap[sender].balance -= tx.amount;
              const key = `${sender}->${recipient}`;
              edgeMap[key] = (edgeMap[key] || 0) + tx.amount;
            }
          }
        }

        // Top 20 addresses by absolute balance
        const addresses = Object.entries(addrMap)
          .sort((a, b) => Math.abs(b[1].balance) - Math.abs(a[1].balance))
          .slice(0, 20);
        const addrSet = new Set(addresses.map(a => a[0]));

        // Filter edges to top addresses
        const edges = Object.entries(edgeMap)
          .filter(([k]) => {
            const [from, to] = k.split('->');
            return addrSet.has(from) && addrSet.has(to);
          })
          .map(([k, v]) => {
            const [from, to] = k.split('->');
            return { from, to, amount: v };
          });

        renderGraph(addresses, edges);
      } catch (e) {
        console.error('Graph error:', e);
      }
    }

    function renderGraph(addresses, edges) {
      const svg = document.getElementById('tx-graph-svg');
      const w = svg.clientWidth || 800;
      const h = 500;
      const cx = w / 2, cy = h / 2;

      const nodesG = document.getElementById('graph-nodes');
      const edgesG = document.getElementById('graph-edges');
      nodesG.innerHTML = '';
      edgesG.innerHTML = '';

      if (addresses.length === 0) {
        nodesG.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#475569" font-size="13">No transaction data to visualize</text>';
        return;
      }

      // Position nodes in a circle
      const r = Math.min(w, h) * 0.35;
      const positions = {};
      const maxBal = Math.max(...addresses.map(a => Math.abs(a[1].balance)), 1);

      addresses.forEach(([addr, info], i) => {
        const angle = -Math.PI / 2 + (i * 2 * Math.PI) / addresses.length;
        positions[addr] = {
          x: cx + r * Math.cos(angle),
          y: cy + r * Math.sin(angle),
          info,
        };
      });

      // Draw edges
      const maxEdge = Math.max(...edges.map(e => e.amount), 1);
      edges.forEach(e => {
        const from = positions[e.from];
        const to = positions[e.to];
        if (!from || !to) return;
        const thickness = Math.max(1, (e.amount / maxEdge) * 5);
        const opacity = Math.max(0.2, Math.min(0.7, e.amount / maxEdge));
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', from.x); line.setAttribute('y1', from.y);
        line.setAttribute('x2', to.x); line.setAttribute('y2', to.y);
        line.setAttribute('stroke', '#6366f1');
        line.setAttribute('stroke-width', thickness);
        line.setAttribute('stroke-opacity', opacity);
        line.setAttribute('marker-end', 'url(#arrowhead)');
        edgesG.appendChild(line);

        // Edge label
        const midX = (from.x + to.x) / 2;
        const midY = (from.y + to.y) / 2;
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', midX); label.setAttribute('y', midY - 4);
        label.setAttribute('text-anchor', 'middle');
        label.setAttribute('fill', '#475569');
        label.setAttribute('font-size', '8');
        label.setAttribute('font-family', "'JetBrains Mono', monospace");
        label.textContent = e.amount.toFixed(1);
        edgesG.appendChild(label);
      });

      // Draw nodes
      addresses.forEach(([addr, info]) => {
        const pos = positions[addr];
        const nodeR = Math.max(8, (Math.abs(info.balance) / maxBal) * 22);
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('transform', `translate(${pos.x},${pos.y})`);
        g.style.cursor = 'pointer';
        g.addEventListener('click', () => searchAddress(addr));

        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('r', nodeR);
        circle.setAttribute('fill', info.isMiner ? '#f59e0b' : '#6366f1');
        circle.setAttribute('opacity', '0.8');
        circle.setAttribute('filter', 'url(#node-glow)');
        g.appendChild(circle);

        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('text-anchor', 'middle');
        label.setAttribute('dy', nodeR + 12);
        label.setAttribute('fill', '#94a3b8');
        label.setAttribute('font-size', '8');
        label.setAttribute('font-family', "'JetBrains Mono', monospace");
        label.textContent = truncAddr(addr, 6);
        g.appendChild(label);

        const balLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        balLabel.setAttribute('text-anchor', 'middle');
        balLabel.setAttribute('dy', '3');
        balLabel.setAttribute('fill', '#fff');
        balLabel.setAttribute('font-size', '7');
        balLabel.setAttribute('font-weight', '600');
        balLabel.setAttribute('font-family', "'JetBrains Mono', monospace");
        balLabel.textContent = Math.abs(info.balance).toFixed(1);
        g.appendChild(balLabel);

        nodesG.appendChild(g);
      });
    }

    // =======================================================================
    // CONSENSUS
    // =======================================================================
    async function loadConsensusInfo() {
      try {
        const info = await apiFetch('/consensus');
        const el = document.getElementById('consensus-detail');
        el.innerHTML = `
          <div class="grid grid-cols-2 gap-3">
            ${Object.entries(info).map(([k, v]) => `
              <div class="bg-slate-800/40 rounded-lg p-2.5 border border-slate-800/60">
                <p class="text-[10px] text-slate-500 uppercase">${escHtml(k.replace(/_/g, ' '))}</p>
                <p class="text-sm mono text-slate-200">${typeof v === 'object' ? JSON.stringify(v) : escHtml(String(v))}</p>
              </div>
            `).join('')}
          </div>`;
      } catch (e) {
        document.getElementById('consensus-detail').innerHTML = `<p class="text-xs text-red-400">${escHtml(e.message)}</p>`;
      }
    }

    async function switchConsensus(engine) {
      const resultPanel = document.getElementById('consensus-switch-result');
      const resultContent = document.getElementById('consensus-switch-content');
      resultPanel.classList.remove('hidden');
      resultContent.innerHTML = '<p class="text-xs text-slate-500">Switching consensus engine...</p>';

      const body = { engine };
      if (engine === 'pow') body.difficulty = parseInt(document.getElementById('pow-difficulty').value) || 4;
      if (engine === 'pos') body.min_stake = parseFloat(document.getElementById('pos-min-stake').value) || 10;
      if (engine === 'pbft') body.total_nodes = parseInt(document.getElementById('pbft-nodes').value) || 31;

      try {
        const result = await apiPost('/consensus/switch', body);
        resultContent.innerHTML = `
          <div class="slide-in">
            <p class="text-emerald-400 text-sm font-semibold mb-2">Consensus engine switched successfully</p>
            <div class="grid grid-cols-2 gap-2">
              ${Object.entries(result).map(([k, v]) => `
                <div class="bg-slate-800/40 rounded-lg p-2 border border-slate-800/60">
                  <p class="text-[10px] text-slate-500 uppercase">${escHtml(k.replace(/_/g, ' '))}</p>
                  <p class="text-xs mono text-slate-300">${typeof v === 'object' ? JSON.stringify(v) : escHtml(String(v))}</p>
                </div>
              `).join('')}
            </div>
          </div>`;
        loadConsensusInfo();
      } catch (e) {
        resultContent.innerHTML = `<p class="text-xs text-red-400">Error: ${escHtml(e.message)}</p>`;
      }
    }

    async function loadStakes() {
      try {
        const data = await apiFetch('/stakes');
        const el = document.getElementById('stakes-list');
        const stakes = data.stakes || [];
        if (stakes.length === 0) {
          el.innerHTML = '<p class="text-xs text-slate-600 text-center py-4">No stakes registered</p>';
          return;
        }
        el.innerHTML = stakes.map(s => `
          <div class="bg-slate-800/40 rounded-lg p-3 border border-slate-800/60 flex items-center justify-between">
            <div>
              <p class="text-xs mono text-slate-300">${escHtml(s.address || s.validator || '')}</p>
            </div>
            <p class="text-sm font-bold mono text-violet-400">${(s.stake || s.amount || 0).toFixed(2)} ATL</p>
          </div>
        `).join('');
      } catch (e) {
        document.getElementById('stakes-list').innerHTML = `<p class="text-xs text-red-400">${escHtml(e.message)}</p>`;
      }
    }

    // =======================================================================
    // MEMPOOL
    // =======================================================================
    async function loadMempool() {
      try {
        const [mempoolInfo, pending] = await Promise.all([
          apiFetch('/mempool'),
          apiFetch('/transactions/pending'),
        ]);

        document.getElementById('mp-count').textContent = mempoolInfo.size ?? (pending.transactions || []).length;

        const txs = (pending.transactions || []).sort((a, b) => (b.fee || 0) - (a.fee || 0));
        let totalVal = 0, totalFees = 0;
        txs.forEach(tx => { totalVal += tx.amount || 0; totalFees += tx.fee || 0; });
        document.getElementById('mp-value').textContent = totalVal.toFixed(2);
        document.getElementById('mp-fees').textContent = totalFees.toFixed(4);

        if (txs.length > 0 && txs[txs.length - 1].timestamp) {
          document.getElementById('mp-oldest').textContent = fmtAgo(txs[txs.length - 1].timestamp);
        } else {
          document.getElementById('mp-oldest').textContent = '--';
        }

        const el = document.getElementById('mempool-list');
        if (txs.length === 0) {
          el.innerHTML = '<p class="text-xs text-slate-600 text-center py-8">Mempool is empty</p>';
          return;
        }

        el.innerHTML = txs.map((tx, i) => `
          <div class="bg-slate-800/40 rounded-lg p-3 border border-slate-800/60 slide-in">
            <div class="flex items-center justify-between mb-1">
              <div class="flex items-center gap-2">
                <span class="text-[10px] mono text-slate-600">#${i + 1}</span>
                <span class="text-[10px] uppercase font-semibold text-orange-400">Pending</span>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-[10px] text-slate-500">Fee: <span class="mono text-amber-400">${(tx.fee || 0).toFixed(4)}</span></span>
                <span class="text-sm font-bold mono text-slate-200">${tx.amount} ATL</span>
              </div>
            </div>
            <p class="text-[10px] mono text-slate-500">From: ${escHtml(tx.sender || '--')}</p>
            <p class="text-[10px] mono text-slate-400">To: ${escHtml(tx.recipient || '--')}</p>
          </div>
        `).join('');
      } catch (e) {
        document.getElementById('mempool-list').innerHTML = `<p class="text-xs text-red-400 text-center py-8">${escHtml(e.message)}</p>`;
      }
    }

    // =======================================================================
    // CONTRACTS
    // =======================================================================
    async function loadContracts() {
      try {
        const data = await apiFetch('/contracts');
        const el = document.getElementById('contract-list');
        const contracts = data.contracts || [];

        if (contracts.length === 0) {
          el.innerHTML = '<p class="text-xs text-slate-600 text-center py-8">No contracts deployed</p>';
          return;
        }

        el.innerHTML = contracts.map(c => `
          <div class="bg-slate-800/40 rounded-lg p-3 border border-slate-800/60 cursor-pointer hover:bg-slate-800/60 transition" onclick="showContractDetail('${escHtml(c.address)}')">
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs font-semibold text-indigo-400">${escHtml(c.label || 'Unnamed Contract')}</span>
              <span class="badge bg-emerald-500/10 text-emerald-400 border border-emerald-500/30">Active</span>
            </div>
            <p class="text-[10px] mono text-slate-400 break-all">${escHtml(c.address)}</p>
            <p class="text-[10px] text-slate-600 mt-1">Owner: ${escHtml(truncAddr(c.owner || ''))}</p>
          </div>
        `).join('');
      } catch (e) {
        document.getElementById('contract-list').innerHTML = `<p class="text-xs text-red-400 text-center py-8">${escHtml(e.message)}</p>`;
      }
    }

    async function showContractDetail(address) {
      const panel = document.getElementById('contract-detail-panel');
      const content = document.getElementById('contract-detail-content');
      panel.classList.remove('hidden');
      content.innerHTML = '<p class="text-xs text-slate-500">Loading contract...</p>';

      try {
        const contract = await apiFetch(`/contract/${encodeURIComponent(address)}`);
        content.innerHTML = `
          <div class="space-y-3 fade-in">
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
                <p class="text-[10px] text-slate-500 uppercase">Label</p>
                <p class="text-sm text-slate-200">${escHtml(contract.label || 'Unnamed')}</p>
              </div>
              <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
                <p class="text-[10px] text-slate-500 uppercase">Owner</p>
                <p class="text-[10px] mono text-slate-300 break-all">${escHtml(contract.owner || '--')}</p>
              </div>
            </div>

            <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
              <p class="text-[10px] text-slate-500 uppercase mb-1">Contract Address</p>
              <p class="text-[10px] mono text-indigo-400 break-all">${escHtml(contract.address || address)}</p>
            </div>

            <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
              <p class="text-[10px] text-slate-500 uppercase mb-1">Source Code</p>
              <pre class="text-[10px] mono text-slate-300 whitespace-pre-wrap bg-slate-900 rounded p-2 max-h-48 overflow-y-auto feed">${escHtml(contract.code || '-- no code --')}</pre>
            </div>

            <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
              <p class="text-[10px] text-slate-500 uppercase mb-1">Storage</p>
              <pre class="text-[10px] mono text-slate-300 whitespace-pre-wrap bg-slate-900 rounded p-2 max-h-32 overflow-y-auto feed">${escHtml(JSON.stringify(contract.storage || {}, null, 2))}</pre>
            </div>

            ${contract.call_history ? `
            <div>
              <p class="text-[10px] text-slate-500 uppercase mb-2">Call History</p>
              ${(contract.call_history || []).length === 0 ? '<p class="text-[10px] text-slate-600">No calls yet</p>' :
                (contract.call_history || []).map(call => `
                  <div class="bg-slate-800/40 rounded-lg p-2 border border-slate-800/60 mb-1.5">
                    <p class="text-[10px] mono text-slate-400">Caller: ${escHtml(call.sender || '--')}</p>
                    <p class="text-[10px] mono text-slate-500">Gas: ${call.gas_used || 0}</p>
                  </div>
                `).join('')
              }
            </div>` : ''}
          </div>`;
      } catch (e) {
        content.innerHTML = `<p class="text-xs text-red-400">Error: ${escHtml(e.message)}</p>`;
      }
    }

    async function loadTemplates() {
      try {
        const data = await apiFetch('/contract/templates');
        const el = document.getElementById('template-list');
        const templates = data.templates || {};
        const keys = Object.keys(templates);

        if (keys.length === 0) {
          el.innerHTML = '<p class="text-xs text-slate-600 text-center py-4">No templates available</p>';
          return;
        }

        el.innerHTML = keys.map(k => `
          <div class="bg-slate-800/40 rounded-lg p-3 border border-slate-800/60">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-semibold text-indigo-400">${escHtml(k)}</span>
              <span class="badge bg-slate-700/50 text-slate-400 border border-slate-700">Template</span>
            </div>
            <pre class="text-[10px] mono text-slate-500 whitespace-pre-wrap bg-slate-900 rounded p-2 max-h-24 overflow-y-auto feed">${escHtml(templates[k])}</pre>
          </div>
        `).join('');
      } catch (e) {
        document.getElementById('template-list').innerHTML = `<p class="text-xs text-red-400">${escHtml(e.message)}</p>`;
      }
    }

    // =======================================================================
    // ATTACK SIMULATIONS
    // =======================================================================
    async function simDoubleSpend() {
      const el = document.getElementById('ds-result');
      el.innerHTML = '<p class="text-slate-500">Running simulation...</p>';
      try {
        const body = {
          address: document.getElementById('ds-address').value.trim(),
          amount: parseFloat(document.getElementById('ds-amount').value) || 5,
        };
        const r1 = document.getElementById('ds-recipient1').value.trim();
        const r2 = document.getElementById('ds-recipient2').value.trim();
        if (r1) body.recipient1 = r1;
        if (r2) body.recipient2 = r2;

        const result = await apiPost('/simulate/double-spend', body);
        el.innerHTML = renderSimResult(result);
      } catch (e) {
        el.innerHTML = `<p class="text-red-400">${escHtml(e.message)}</p>`;
      }
    }

    async function sim51Attack() {
      const el = document.getElementById('a51-result');
      el.innerHTML = '<p class="text-slate-500">Running simulation...</p>';
      try {
        const result = await apiPost('/simulate/51-attack', {
          blocks: parseInt(document.getElementById('a51-blocks').value) || 3,
        });
        el.innerHTML = renderSimResult(result);
      } catch (e) {
        el.innerHTML = `<p class="text-red-400">${escHtml(e.message)}</p>`;
      }
    }

    async function simSelfishMining() {
      const el = document.getElementById('sm-result');
      el.innerHTML = '<p class="text-slate-500">Running simulation...</p>';
      try {
        const result = await apiPost('/simulate/selfish-mining', {
          rounds: parseInt(document.getElementById('sm-rounds').value) || 100,
          hash_power: parseFloat(document.getElementById('sm-power').value) || 0.3,
        });
        el.innerHTML = renderSimResult(result);
      } catch (e) {
        el.innerHTML = `<p class="text-red-400">${escHtml(e.message)}</p>`;
      }
    }

    async function simStepMine() {
      const el = document.getElementById('step-result');
      el.innerHTML = '<p class="text-slate-500">Running simulation...</p>';
      try {
        const result = await apiPost('/simulate/step-mine', {
          steps: parseInt(document.getElementById('step-steps').value) || 100,
        });

        let html = `
          <div class="mb-2">
            <span class="text-[10px] text-slate-500">Difficulty: <span class="mono text-cyan-400">${result.difficulty}</span></span>
            <span class="text-[10px] text-slate-500 ml-3">Target: <span class="mono text-amber-400">${escHtml(result.target_prefix)}</span></span>
            <span class="text-[10px] text-slate-500 ml-3">Total attempts: <span class="mono text-slate-300">${result.total_attempts}</span></span>
            <span class="text-[10px] ml-3 font-bold ${result.found ? 'text-emerald-400' : 'text-red-400'}">${result.found ? 'FOUND!' : 'Not found'}</span>
          </div>
          <div class="space-y-0.5">`;

        const attempts = result.attempts || [];
        const displayAttempts = attempts.slice(0, 50);
        displayAttempts.forEach(a => {
          html += `
            <div class="flex items-center gap-2 ${a.valid ? 'bg-emerald-500/10 border border-emerald-500/20 rounded px-2 py-0.5' : ''}">
              <span class="mono text-[9px] text-slate-600 w-12">#${a.proof}</span>
              <span class="mono text-[9px] ${a.valid ? 'text-emerald-400' : 'text-slate-500'} flex-1 truncate">${escHtml(a.hash)}</span>
              <span class="text-[9px] ${a.valid ? 'text-emerald-400 font-bold' : 'text-red-400/50'}">${a.valid ? 'VALID' : 'miss'}</span>
            </div>`;
        });

        if (attempts.length > 50) {
          html += `<p class="text-[10px] text-slate-600 mt-1">... and ${attempts.length - 50} more attempts</p>`;
        }
        html += '</div>';
        el.innerHTML = html;
      } catch (e) {
        el.innerHTML = `<p class="text-red-400">${escHtml(e.message)}</p>`;
      }
    }

    function renderSimResult(result) {
      return `
        <div class="bg-slate-800/40 rounded-lg p-3 border border-slate-800/60 mt-2 slide-in">
          ${Object.entries(result).map(([k, v]) => {
            let valClass = 'text-slate-300';
            if (typeof v === 'boolean') valClass = v ? 'text-emerald-400' : 'text-red-400';
            if (k === 'error') valClass = 'text-red-400';
            if (k === 'note') valClass = 'text-amber-400';
            const displayVal = typeof v === 'object' && v !== null ? JSON.stringify(v, null, 2) : String(v);
            return `
              <div class="flex items-start justify-between py-1 border-b border-slate-800/30 last:border-0">
                <span class="text-[10px] text-slate-500 uppercase">${escHtml(k.replace(/_/g, ' '))}</span>
                <span class="text-[10px] mono ${valClass} text-right max-w-[60%] break-all">${escHtml(displayVal)}</span>
              </div>`;
          }).join('')}
        </div>`;
    }

    // =======================================================================
    // AUTO-REFRESH
    // =======================================================================
    let refreshTimer = null;

    function startAutoRefresh() {
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(() => {
        const activeSection = document.querySelector('.section.active');
        if (!activeSection) return;
        const id = activeSection.id.replace('section-', '');
        switch (id) {
          case 'dashboard': loadDashboard(); break;
          case 'mempool': loadMempool(); break;
        }
      }, 5000);
    }

    // =======================================================================
    // INIT
    // =======================================================================
    loadDashboard();
    startAutoRefresh();
  </script>
</body>
</html>
