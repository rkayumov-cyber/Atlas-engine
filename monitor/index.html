<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atlas Engine — Network Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', system-ui, sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    #network-canvas { background: radial-gradient(ellipse at center, #0f172a 0%, #020617 100%); }
    .feed { scrollbar-width: thin; scrollbar-color: #334155 transparent; }
    .feed::-webkit-scrollbar { width: 4px; }
    .feed::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
    @keyframes ping-ring { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2.5); opacity: 0; } }
    .ping-ring { animation: ping-ring 1.5s ease-out infinite; }
    @keyframes slide-in { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    .slide-in { animation: slide-in 0.25s ease-out; }
    @keyframes flash-green { 0% { background-color: rgba(34,197,94,0.15); } 100% { background-color: transparent; } }
    .flash-green { animation: flash-green 1s ease-out; }
    .btn { @apply px-3 py-1.5 rounded-lg text-xs font-semibold transition-all duration-150 border; }
    .btn:active { transform: scale(0.97); }
    .btn-primary { @apply bg-indigo-600 border-indigo-500 hover:bg-indigo-500 text-white; }
    .btn-success { @apply bg-emerald-600/20 border-emerald-500/40 hover:bg-emerald-600/60 text-emerald-400; }
    .btn-warning { @apply bg-amber-600/20 border-amber-500/40 hover:bg-amber-600/60 text-amber-400; }
    .btn-danger { @apply bg-red-600/20 border-red-500/40 hover:bg-red-600/60 text-red-400; }
    .modal-backdrop { background: rgba(2,6,23,0.8); backdrop-filter: blur(4px); }
    .sparkline-bar { transition: height 0.3s ease; }
  </style>
</head>
<body class="bg-slate-950 text-gray-100 min-h-screen overflow-x-hidden">

  <!-- Header -->
  <header class="border-b border-slate-800/60 px-6 py-3 flex items-center justify-between backdrop-blur sticky top-0 z-50 bg-slate-950/90">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center font-bold text-sm">A</div>
      <div>
        <h1 class="text-lg font-bold tracking-tight">Network Monitor</h1>
        <p class="text-xs text-slate-500">Atlas Engine — Real-time Visualization</p>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <button onclick="openModal('mine-modal')" class="btn btn-success">Mine Block</button>
      <button onclick="openModal('balance-modal')" class="btn btn-warning">Check Balance</button>
      <button onclick="openModal('wallet-modal');refreshWalletList()" class="btn btn-primary">Wallets</button>
      <button onclick="openModal('transfer-modal');loadTransferWallets()" class="btn btn-warning">Transfer</button>
      <button onclick="openModal('faucet-modal')" class="btn btn-success">Faucet</button>
      <button onclick="openModal('consensus-modal')" class="btn btn-primary">Consensus</button>
      <button onclick="openModal('contract-modal')" class="btn btn-warning">Contracts</button>
      <button onclick="openModal('staking-modal');loadStakes()" class="btn btn-success">Staking</button>
      <button onclick="openModal('simulation-modal')" class="btn btn-danger">Simulations</button>
      <a href="/explorer" class="btn btn-primary">Explorer</a>
      <button onclick="triggerConsensus()" class="btn btn-primary" id="consensus-btn">Sync</button>
      <div class="flex items-center gap-2 text-xs text-slate-400">
        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse" id="conn-dot"></span>
        <span id="connection-status">Connected</span>
      </div>
      <span id="clock" class="text-xs text-slate-500 mono"></span>
    </div>
  </header>

  <main class="flex flex-col lg:flex-row h-[calc(100vh-57px)]">

    <!-- ============ LEFT PANEL: Visualization ============ -->
    <div class="flex-1 flex flex-col min-w-0">

      <!-- Stats Bar (8 metrics) -->
      <div class="grid grid-cols-4 xl:grid-cols-8 gap-2 p-3 border-b border-slate-800/40">
        <div class="bg-slate-900/60 rounded-lg px-3 py-2 border border-slate-800/40">
          <p class="text-[10px] uppercase tracking-wider text-slate-500">Nodes</p>
          <p class="text-lg font-bold mono text-green-400" id="stat-nodes">0/31</p>
        </div>
        <div class="bg-slate-900/60 rounded-lg px-3 py-2 border border-slate-800/40">
          <p class="text-[10px] uppercase tracking-wider text-slate-500">Max Chain</p>
          <p class="text-lg font-bold mono text-indigo-400" id="stat-blocks">0</p>
        </div>
        <div class="bg-slate-900/60 rounded-lg px-3 py-2 border border-slate-800/40">
          <p class="text-[10px] uppercase tracking-wider text-slate-500">Total TXs</p>
          <p class="text-lg font-bold mono text-amber-400" id="stat-txs">0</p>
        </div>
        <div class="bg-slate-900/60 rounded-lg px-3 py-2 border border-slate-800/40">
          <p class="text-[10px] uppercase tracking-wider text-slate-500">Tokens Mined</p>
          <p class="text-lg font-bold mono text-emerald-400" id="stat-tokens">0.0</p>
        </div>
        <div class="bg-slate-900/60 rounded-lg px-3 py-2 border border-slate-800/40">
          <p class="text-[10px] uppercase tracking-wider text-slate-500">Avg Block Time</p>
          <p class="text-lg font-bold mono text-cyan-400" id="stat-blocktime">--</p>
        </div>
        <div class="bg-slate-900/60 rounded-lg px-3 py-2 border border-slate-800/40">
          <p class="text-[10px] uppercase tracking-wider text-slate-500">TPS (recent)</p>
          <p class="text-lg font-bold mono text-pink-400" id="stat-tps">0.0</p>
        </div>
        <div class="bg-slate-900/60 rounded-lg px-3 py-2 border border-slate-800/40">
          <p class="text-[10px] uppercase tracking-wider text-slate-500">Addresses</p>
          <p class="text-lg font-bold mono text-violet-400" id="stat-addresses">0</p>
        </div>
        <div class="bg-slate-900/60 rounded-lg px-3 py-2 border border-slate-800/40">
          <p class="text-[10px] uppercase tracking-wider text-slate-500">Total Supply</p>
          <p class="text-lg font-bold mono text-yellow-400" id="stat-supply">0.0</p>
        </div>
      </div>

      <!-- Network Graph -->
      <div class="flex-1 relative">
        <svg id="network-canvas" class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <filter id="glow"><feGaussianBlur stdDeviation="4" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
            <filter id="glow-strong"><feGaussianBlur stdDeviation="8" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          </defs>
          <g id="links-layer"></g>
          <g id="particles-layer"></g>
          <g id="nodes-layer"></g>
        </svg>

        <!-- Legend -->
        <div class="absolute bottom-4 left-4 bg-slate-900/80 backdrop-blur rounded-lg border border-slate-800/60 px-3 py-2 text-[10px] text-slate-400 space-y-1">
          <div class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-full bg-green-500"></span> Online</div>
          <div class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-full bg-red-500"></span> Offline</div>
          <div class="flex items-center gap-2"><span class="w-3 h-0.5 bg-indigo-500 rounded"></span> P2P Link</div>
          <div class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-full bg-amber-400"></span> TX Flow</div>
        </div>

        <!-- Throughput Sparkline -->
        <div class="absolute bottom-4 right-4 bg-slate-900/80 backdrop-blur rounded-lg border border-slate-800/60 px-3 py-2">
          <p class="text-[10px] uppercase tracking-wider text-slate-500 mb-1">Block Throughput (last 20)</p>
          <div class="flex items-end gap-[2px] h-10" id="sparkline"></div>
        </div>
      </div>

      <!-- Node Comparison Bar -->
      <div class="border-t border-slate-800/40 p-3">
        <p class="text-[10px] uppercase tracking-wider text-slate-500 mb-2">Chain Comparison</p>
        <div class="grid grid-cols-4 lg:grid-cols-8 xl:grid-cols-10 gap-2" id="chain-compare"></div>
      </div>
    </div>

    <!-- ============ RIGHT PANEL: Feeds & Controls ============ -->
    <div class="w-full lg:w-[400px] border-l border-slate-800/40 flex flex-col">

      <!-- Tabs -->
      <div class="flex border-b border-slate-800/40">
        <button class="tab-btn flex-1 py-2.5 text-xs font-semibold uppercase tracking-wider text-indigo-400 border-b-2 border-indigo-500" data-tab="transactions">Transactions</button>
        <button class="tab-btn flex-1 py-2.5 text-xs font-semibold uppercase tracking-wider text-slate-500 border-b-2 border-transparent hover:text-slate-300" data-tab="blocks">Blocks</button>
        <button class="tab-btn flex-1 py-2.5 text-xs font-semibold uppercase tracking-wider text-slate-500 border-b-2 border-transparent hover:text-slate-300" data-tab="events">Event Log</button>
      </div>

      <!-- Transaction Feed -->
      <div id="tab-transactions" class="flex-1 overflow-y-auto feed p-3 space-y-2">
        <p class="text-xs text-slate-600 text-center py-8">Waiting for transactions...</p>
      </div>

      <!-- Block Feed -->
      <div id="tab-blocks" class="flex-1 overflow-y-auto feed p-3 space-y-2 hidden">
        <p class="text-xs text-slate-600 text-center py-8">Waiting for blocks...</p>
      </div>

      <!-- Event Log -->
      <div id="tab-events" class="flex-1 overflow-y-auto feed p-3 space-y-1 hidden">
        <p class="text-xs text-slate-600 text-center py-8">No events yet...</p>
      </div>

      <!-- Node Detail Cards -->
      <div class="border-t border-slate-800/40 p-3" id="node-details">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[10px] uppercase tracking-wider text-slate-500">Node Details</p>
          <p class="text-[10px] text-slate-600 mono" id="last-poll">--</p>
        </div>
        <div id="node-cards" class="space-y-2"></div>
      </div>
    </div>
  </main>

  <!-- ============ MINE MODAL ============ -->
  <div id="mine-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 border border-slate-700 rounded-xl w-[520px] max-h-[80vh] p-5 shadow-2xl overflow-y-auto feed">
      <h3 class="text-sm font-bold mb-4">Mine a Block</h3>
      <p class="text-xs text-slate-400 mb-3">Select which node should mine the next block:</p>
      <div class="grid grid-cols-4 gap-2 mb-4" id="mine-buttons"></div>
      <div id="mine-result" class="text-xs mono text-slate-400 min-h-[20px] mb-3"></div>
      <button onclick="closeModal('mine-modal')" class="w-full btn border-slate-700 text-slate-400 hover:text-slate-200">Close</button>
    </div>
  </div>

  <!-- ============ BALANCE MODAL ============ -->
  <div id="balance-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 border border-slate-700 rounded-xl w-[420px] p-5 shadow-2xl">
      <h3 class="text-sm font-bold mb-4">Check Balance</h3>
      <div class="mb-3">
        <label class="text-[10px] uppercase tracking-wider text-slate-500 block mb-1">Address</label>
        <input id="balance-addr" type="text" placeholder="Enter wallet address or node ID..." class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs mono text-slate-200 focus:outline-none focus:border-indigo-500" />
      </div>
      <div class="flex gap-2 mb-3">
        <select id="balance-node" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none"></select>
        <button onclick="checkBalance()" class="btn btn-warning">Lookup</button>
      </div>
      <div id="balance-result" class="text-xs min-h-[20px] mb-3"></div>
      <p class="text-[10px] text-slate-600 mb-2">Quick lookup — known miner addresses:</p>
      <div id="known-addresses" class="space-y-1 max-h-[120px] overflow-y-auto feed mb-3"></div>
      <button onclick="closeModal('balance-modal')" class="w-full btn border-slate-700 text-slate-400 hover:text-slate-200">Close</button>
    </div>
  </div>

  <!-- ============ BLOCK DETAIL MODAL ============ -->
  <div id="block-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 border border-slate-700 rounded-xl w-[500px] max-h-[80vh] p-5 shadow-2xl overflow-y-auto feed">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-bold">Block Details</h3>
        <button onclick="closeModal('block-modal')" class="text-slate-500 hover:text-slate-300 text-lg">&times;</button>
      </div>
      <div id="block-detail-content"></div>
    </div>
  </div>

  <!-- ============ WALLET MANAGER MODAL ============ -->
  <div id="wallet-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 border border-slate-700 rounded-xl w-[480px] max-h-[80vh] p-5 shadow-2xl overflow-y-auto feed">
      <h3 class="text-sm font-bold mb-4">Wallet Manager</h3>
      <div class="mb-4">
        <p class="text-xs text-slate-400 mb-2">Create a new wallet:</p>
        <div class="flex gap-2 mb-2">
          <select id="wallet-node" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none"></select>
          <input id="wallet-label" type="text" placeholder="Label (optional)" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none focus:border-indigo-500" />
        </div>
        <button onclick="createWallet()" class="btn btn-primary w-full">Create Wallet</button>
        <div id="wallet-create-result" class="text-xs mono text-slate-400 mt-2 min-h-[20px]"></div>
      </div>
      <hr class="border-slate-800 mb-3" />
      <div class="flex items-center justify-between mb-2">
        <p class="text-xs text-slate-400">Wallets on selected node:</p>
        <button onclick="refreshWalletList()" class="text-[10px] text-indigo-400 hover:text-indigo-300">Refresh</button>
      </div>
      <div id="wallet-list" class="space-y-2">
        <p class="text-xs text-slate-600 text-center py-4">Select a node to view wallets</p>
      </div>
      <button onclick="closeModal('wallet-modal')" class="w-full btn border-slate-700 text-slate-400 hover:text-slate-200 mt-4">Close</button>
    </div>
  </div>

  <!-- ============ TRANSFER MODAL ============ -->
  <div id="transfer-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 border border-slate-700 rounded-xl w-[420px] p-5 shadow-2xl">
      <h3 class="text-sm font-bold mb-4">Transfer ATL</h3>
      <div class="space-y-3 mb-4">
        <div>
          <label class="text-[10px] uppercase tracking-wider text-slate-500 block mb-1">Node</label>
          <select id="transfer-node" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none" onchange="loadTransferWallets()"></select>
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-slate-500 block mb-1">From Wallet</label>
          <select id="transfer-from" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs mono text-slate-300 focus:outline-none">
            <option value="">Select a wallet...</option>
          </select>
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-slate-500 block mb-1">To Address</label>
          <input id="transfer-to" type="text" placeholder="Recipient address..." class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs mono text-slate-300 focus:outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-slate-500 block mb-1">Amount (ATL)</label>
          <input id="transfer-amount" type="number" min="0.01" step="0.01" placeholder="0.00" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs mono text-slate-300 focus:outline-none focus:border-indigo-500" />
        </div>
      </div>
      <button onclick="executeTransfer()" class="btn btn-warning w-full mb-3">Send Transfer</button>
      <div id="transfer-result" class="text-xs mono text-slate-400 min-h-[20px] mb-3"></div>
      <button onclick="closeModal('transfer-modal')" class="w-full btn border-slate-700 text-slate-400 hover:text-slate-200">Close</button>
    </div>
  </div>

  <!-- ============ FAUCET MODAL ============ -->
  <div id="faucet-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 border border-slate-700 rounded-xl w-[420px] p-5 shadow-2xl">
      <h3 class="text-sm font-bold mb-4">Token Faucet</h3>
      <p class="text-xs text-slate-400 mb-3">Request free ATL tokens (max 100 per request):</p>
      <div class="space-y-3 mb-4">
        <div>
          <label class="text-[10px] uppercase tracking-wider text-slate-500 block mb-1">Node</label>
          <select id="faucet-node" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none" onchange="loadFaucetAddresses()"></select>
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-slate-500 block mb-1">Address</label>
          <select id="faucet-known" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs mono text-slate-300 focus:outline-none mb-1">
            <option value="">-- Pick from known wallets --</option>
          </select>
          <input id="faucet-address" type="text" placeholder="Or enter address manually..." class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs mono text-slate-300 focus:outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-slate-500 block mb-1">Amount (ATL)</label>
          <input id="faucet-amount" type="number" min="1" max="100" value="10" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs mono text-slate-300 focus:outline-none focus:border-indigo-500" />
        </div>
      </div>
      <button onclick="requestFaucet()" class="btn btn-success w-full mb-3">Request Tokens</button>
      <div id="faucet-result" class="text-xs mono text-slate-400 min-h-[20px] mb-3"></div>
      <button onclick="closeModal('faucet-modal')" class="w-full btn border-slate-700 text-slate-400 hover:text-slate-200">Close</button>
    </div>
  </div>

  <!-- ============ CONSENSUS MODAL ============ -->
  <div id="consensus-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 border border-slate-700 rounded-xl w-[420px] p-5 shadow-2xl">
      <h3 class="text-sm font-bold mb-4">Consensus Engine</h3>
      <div id="consensus-info" class="mb-4 bg-slate-800/60 rounded-lg p-3 border border-slate-800 text-xs mono text-slate-300">Loading...</div>
      <p class="text-xs text-slate-400 mb-3">Switch consensus engine:</p>
      <div class="grid grid-cols-3 gap-2 mb-4">
        <button onclick="switchConsensus('pow')" class="btn btn-success">PoW</button>
        <button onclick="switchConsensus('pos')" class="btn btn-warning">PoS</button>
        <button onclick="switchConsensus('pbft')" class="btn btn-primary">PBFT</button>
      </div>
      <div id="consensus-result" class="text-xs mono text-slate-400 min-h-[20px] mb-3"></div>
      <button onclick="closeModal('consensus-modal')" class="w-full btn border-slate-700 text-slate-400 hover:text-slate-200">Close</button>
    </div>
  </div>

  <!-- ============ CONTRACT MODAL ============ -->
  <div id="contract-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 border border-slate-700 rounded-xl w-[500px] max-h-[80vh] p-5 shadow-2xl overflow-y-auto feed">
      <h3 class="text-sm font-bold mb-4">Smart Contracts</h3>
      <div class="mb-4">
        <p class="text-xs text-slate-400 mb-2">Deploy from template:</p>
        <div class="flex gap-2 mb-2">
          <input id="contract-owner" type="text" placeholder="Owner address..." class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs mono text-slate-300 focus:outline-none focus:border-indigo-500" />
          <select id="contract-template" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none">
            <option value="token">Token</option>
            <option value="escrow">Escrow</option>
          </select>
        </div>
        <button onclick="deployContract()" class="btn btn-primary w-full">Deploy Contract</button>
        <div id="contract-deploy-result" class="text-xs mono text-slate-400 mt-2 min-h-[20px]"></div>
      </div>
      <hr class="border-slate-800 mb-3" />
      <p class="text-xs text-slate-400 mb-2">Deployed contracts:</p>
      <div id="contract-list" class="space-y-2">
        <p class="text-xs text-slate-600 text-center py-4">Loading...</p>
      </div>
      <button onclick="closeModal('contract-modal')" class="w-full btn border-slate-700 text-slate-400 hover:text-slate-200 mt-4">Close</button>
    </div>
  </div>

  <!-- ============ STAKING MODAL ============ -->
  <div id="staking-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 border border-slate-700 rounded-xl w-[480px] max-h-[80vh] p-5 shadow-2xl overflow-y-auto feed">
      <h3 class="text-sm font-bold mb-4">Staking (PoS)</h3>
      <p class="text-xs text-slate-400 mb-3">Stake tokens to participate in Proof-of-Stake consensus:</p>
      <div class="space-y-3 mb-4">
        <div>
          <label class="text-[10px] uppercase tracking-wider text-slate-500 block mb-1">Address</label>
          <input id="stake-address" type="text" placeholder="Wallet address..." class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs mono text-slate-200 focus:outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-slate-500 block mb-1">Amount (ATL)</label>
          <input id="stake-amount" type="number" min="1" step="1" value="100" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs mono text-slate-200 focus:outline-none focus:border-indigo-500" />
        </div>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="doStake()" class="btn btn-success">Stake</button>
          <button onclick="doUnstake()" class="btn btn-danger">Unstake</button>
        </div>
      </div>
      <div id="stake-result" class="text-xs mono text-slate-400 min-h-[20px] mb-3"></div>
      <hr class="border-slate-800 mb-3" />
      <p class="text-xs text-slate-400 mb-2">Current stakes:</p>
      <div id="stake-list" class="space-y-2 mb-4">
        <p class="text-xs text-slate-600 text-center py-4">Loading...</p>
      </div>
      <button onclick="closeModal('staking-modal')" class="w-full btn border-slate-700 text-slate-400 hover:text-slate-200">Close</button>
    </div>
  </div>

  <!-- ============ SIMULATION MODAL ============ -->
  <div id="simulation-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 border border-slate-700 rounded-xl w-[520px] max-h-[80vh] p-5 shadow-2xl overflow-y-auto feed">
      <h3 class="text-sm font-bold mb-4">Attack Simulations</h3>
      <p class="text-xs text-slate-400 mb-4">Run educational attack simulations against the network:</p>
      <div class="grid grid-cols-2 gap-3 mb-4">
        <button onclick="runSimulation('double-spend')" class="bg-slate-800/60 hover:bg-slate-800 border border-slate-700 rounded-lg p-3 text-left transition">
          <p class="text-xs font-semibold text-red-400 mb-1">Double Spend</p>
          <p class="text-[10px] text-slate-500">Attempt to spend the same tokens twice</p>
        </button>
        <button onclick="runSimulation('51-attack')" class="bg-slate-800/60 hover:bg-slate-800 border border-slate-700 rounded-lg p-3 text-left transition">
          <p class="text-xs font-semibold text-amber-400 mb-1">51% Attack</p>
          <p class="text-[10px] text-slate-500">Simulate majority hashpower attack</p>
        </button>
        <button onclick="runSimulation('selfish-mining')" class="bg-slate-800/60 hover:bg-slate-800 border border-slate-700 rounded-lg p-3 text-left transition">
          <p class="text-xs font-semibold text-purple-400 mb-1">Selfish Mining</p>
          <p class="text-[10px] text-slate-500">Withhold blocks to gain advantage</p>
        </button>
        <button onclick="runSimulation('step-mine')" class="bg-slate-800/60 hover:bg-slate-800 border border-slate-700 rounded-lg p-3 text-left transition">
          <p class="text-xs font-semibold text-cyan-400 mb-1">Step-through Mining</p>
          <p class="text-[10px] text-slate-500">Watch mining happen step by step</p>
        </button>
      </div>
      <div id="sim-result" class="bg-slate-800/60 rounded-lg p-3 border border-slate-800 text-xs mono text-slate-300 min-h-[80px] mb-4 whitespace-pre-wrap">
        Select a simulation to run...
      </div>
      <button onclick="closeModal('simulation-modal')" class="w-full btn border-slate-700 text-slate-400 hover:text-slate-200">Close</button>
    </div>
  </div>

  <script>
    // =====================================================================
    // CONFIG
    // =====================================================================
    const NODE_COLORS = [
      "#6366f1","#8b5cf6","#a78bfa","#c084fc","#818cf8","#67e8f9",
      "#f472b6","#fb923c","#facc15","#4ade80","#2dd4bf","#38bdf8",
      "#e879f9","#fb7185","#a3e635","#34d399","#22d3ee","#a5b4fc",
      "#fbbf24","#f87171","#86efac","#7dd3fc","#d946ef","#f97316",
      "#10b981","#6ee7b7","#93c5fd","#c4b5fd","#fca5a5","#bef264",
      "#5eead4",
    ];
    const NODES = Array.from({ length: 31 }, (_, i) => ({
      id: `node-${i + 1}`,
      name: `Node ${i + 1}`,
      color: NODE_COLORS[i % NODE_COLORS.length],
      api: `/api/node${i + 1}`,
    }));
    const POLL_MS = 3000;

    // =====================================================================
    // STATE
    // =====================================================================
    let nodesState = {};
    let prevChains = {};
    let particleQueue = [];
    let blockTimestamps = [];      // timestamps of recently observed blocks
    let txCountHistory = [];       // { time, count } for TPS calc
    let sparklineData = [];        // tx counts per block for sparkline
    let knownAddresses = new Set();
    const startTime = Date.now();
    let pollCount = 0;

    // =====================================================================
    // UTILS
    // =====================================================================
    function truncAddr(a) { return !a ? "???" : a.length <= 14 ? a : a.slice(0,8) + ".." + a.slice(-4); }
    function fmtTime(s) { const m = Math.floor(s/60), h = Math.floor(m/60); return h > 0 ? `${h}:${String(m%60).padStart(2,'0')}:${String(Math.floor(s)%60).padStart(2,'0')}` : `${m}:${String(Math.floor(s)%60).padStart(2,'0')}`; }

    // =====================================================================
    // CLOCK & UPTIME
    // =====================================================================
    setInterval(() => {
      document.getElementById("clock").textContent = new Date().toLocaleTimeString();
    }, 1000);

    // =====================================================================
    // MODAL HELPERS
    // =====================================================================
    function openModal(id) { document.getElementById(id).classList.remove("hidden"); }
    function closeModal(id) { document.getElementById(id).classList.add("hidden"); }

    // =====================================================================
    // TABS
    // =====================================================================
    const TAB_IDS = ["transactions", "blocks", "events"];
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => { b.classList.remove("text-indigo-400","border-indigo-500"); b.classList.add("text-slate-500","border-transparent"); });
        btn.classList.remove("text-slate-500","border-transparent"); btn.classList.add("text-indigo-400","border-indigo-500");
        TAB_IDS.forEach(t => document.getElementById("tab-"+t).classList.toggle("hidden", btn.dataset.tab !== t));
      });
    });

    // =====================================================================
    // EVENT LOG
    // =====================================================================
    function logEvent(msg, type = "info") {
      const feed = document.getElementById("tab-events");
      if (feed.querySelector("p.text-slate-600")) feed.innerHTML = "";
      const colors = { info: "text-slate-400", success: "text-emerald-400", warn: "text-amber-400", error: "text-red-400" };
      const el = document.createElement("div");
      el.className = `slide-in text-[11px] mono ${colors[type] || colors.info} py-0.5`;
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      feed.insertBefore(el, feed.firstChild);
      while (feed.children.length > 200) feed.removeChild(feed.lastChild);
    }

    // =====================================================================
    // MINE ACTION
    // =====================================================================
    async function mineOn(idx) {
      const el = document.getElementById("mine-result");
      el.innerHTML = `<span class="text-slate-500">Mining on ${NODES[idx].name}...</span>`;
      logEvent(`Mining requested on ${NODES[idx].name}`, "info");
      try {
        const res = await fetch(`${NODES[idx].api}/mine`, { signal: AbortSignal.timeout(120000) });
        const data = await res.json();
        el.innerHTML = `<span class="text-emerald-400">Block #${data.index} mined! proof=${data.proof}, ${data.transactions.length} tx(s)</span>`;
        logEvent(`Block #${data.index} mined on ${NODES[idx].name} (proof=${data.proof})`, "success");
        poll();
      } catch (e) {
        el.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
        logEvent(`Mining failed on ${NODES[idx].name}: ${e.message}`, "error");
      }
    }
    async function mineOnAll() {
      const el = document.getElementById("mine-result");
      el.innerHTML = `<span class="text-slate-500">Mining on all nodes...</span>`;
      const results = await Promise.allSettled(NODES.map((_, i) => mineOn(i)));
      el.innerHTML = `<span class="text-emerald-400">Done. Mined on ${results.filter(r=>r.status==='fulfilled').length} node(s).</span>`;
    }

    // =====================================================================
    // BALANCE LOOKUP
    // =====================================================================
    async function checkBalance() {
      const addr = document.getElementById("balance-addr").value.trim();
      if (!addr) return;
      const nodeIdx = parseInt(document.getElementById("balance-node").value);
      const el = document.getElementById("balance-result");
      el.innerHTML = `<span class="text-slate-500">Querying...</span>`;
      try {
        const res = await fetch(`${NODES[nodeIdx].api}/balance/${addr}`, { signal: AbortSignal.timeout(5000) });
        const data = await res.json();
        el.innerHTML = `<div class="bg-slate-800 rounded-lg p-3 border border-slate-700">
          <p class="text-[10px] text-slate-500 mb-1">Balance on ${NODES[nodeIdx].name}</p>
          <p class="text-2xl font-bold mono text-emerald-400">${data.balance} <span class="text-sm text-slate-500">ATL</span></p>
          <p class="text-[10px] mono text-slate-600 mt-1 break-all">${data.address}</p>
        </div>`;
        logEvent(`Balance lookup: ${truncAddr(addr)} = ${data.balance} ATL`, "info");
      } catch (e) {
        el.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
      }
    }
    function quickLookup(addr) {
      document.getElementById("balance-addr").value = addr;
      checkBalance();
    }
    function renderKnownAddresses() {
      const container = document.getElementById("known-addresses");
      if (knownAddresses.size === 0) { container.innerHTML = '<p class="text-[10px] text-slate-600">None yet — mine some blocks first</p>'; return; }
      container.innerHTML = [...knownAddresses].map(a => `
        <button onclick="quickLookup('${a}')" class="w-full text-left bg-slate-800/60 hover:bg-slate-800 rounded px-2 py-1 text-[10px] mono text-slate-400 truncate transition">${a}</button>
      `).join("");
    }

    // =====================================================================
    // CONSENSUS
    // =====================================================================
    async function triggerConsensus() {
      const btn = document.getElementById("consensus-btn");
      btn.textContent = "Syncing...";
      btn.disabled = true;
      logEvent("Consensus resolution triggered on all nodes", "warn");
      try {
        const results = await Promise.all(NODES.map(n => fetch(`${n.api}/nodes/resolve`, { signal: AbortSignal.timeout(10000) }).then(r=>r.json()).catch(()=>null)));
        results.forEach((r, i) => {
          if (r) logEvent(`${NODES[i].name}: ${r.message}`, r.message.includes("replaced") ? "warn" : "success");
        });
        await poll();
      } catch (e) { logEvent(`Consensus error: ${e.message}`, "error"); }
      btn.textContent = "Sync Consensus";
      btn.disabled = false;
    }

    // =====================================================================
    // BLOCK DETAIL MODAL
    // =====================================================================
    function showBlockDetail(block, nodeName) {
      const c = document.getElementById("block-detail-content");
      c.innerHTML = `
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
              <p class="text-[10px] text-slate-500 uppercase">Index</p>
              <p class="text-lg font-bold mono text-indigo-400">#${block.index}</p>
            </div>
            <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
              <p class="text-[10px] text-slate-500 uppercase">Proof of Work</p>
              <p class="text-lg font-bold mono text-cyan-400">${block.proof}</p>
            </div>
          </div>
          <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
            <p class="text-[10px] text-slate-500 uppercase mb-1">Timestamp</p>
            <p class="text-xs mono text-slate-300">${new Date(block.timestamp * 1000).toLocaleString()}</p>
          </div>
          <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
            <p class="text-[10px] text-slate-500 uppercase mb-1">Previous Hash</p>
            <p class="text-xs mono text-slate-300 break-all">${block.previous_hash}</p>
          </div>
          <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-800">
            <p class="text-[10px] text-slate-500 uppercase mb-1">Source</p>
            <p class="text-xs text-slate-300">${nodeName}</p>
          </div>
          <div>
            <p class="text-[10px] text-slate-500 uppercase mb-2">Transactions (${block.transactions.length})</p>
            ${block.transactions.length === 0 ? '<p class="text-xs text-slate-600">No transactions</p>' :
              block.transactions.map(tx => `
                <div class="bg-slate-800/40 rounded-lg p-2.5 border border-slate-800 mb-2">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] uppercase ${tx.sender==='MINING_REWARD' ? 'text-emerald-500' : 'text-amber-500'} font-semibold">${tx.sender==='MINING_REWARD' ? 'Coinbase' : 'Transfer'}</span>
                    <span class="text-sm font-bold mono ${tx.sender==='MINING_REWARD' ? 'text-emerald-400' : 'text-amber-400'}">+${tx.amount} ATL</span>
                  </div>
                  <p class="text-[10px] mono text-slate-500">From: ${tx.sender==='MINING_REWARD' ? 'COINBASE' : tx.sender}</p>
                  <p class="text-[10px] mono text-slate-400">To: ${tx.recipient}</p>
                  ${tx.signature ? `<p class="text-[10px] mono text-slate-600 truncate mt-1">Sig: ${tx.signature.slice(0,32)}...</p>` : ''}
                </div>
              `).join("")
            }
          </div>
        </div>`;
      openModal("block-modal");
    }

    // =====================================================================
    // NETWORK GRAPH
    // =====================================================================
    function getPositions() {
      const svg = document.getElementById("network-canvas");
      const w = svg.clientWidth || 800, h = svg.clientHeight || 500;
      const cx = w/2, cy = h/2;
      // Use two concentric rings for 31 nodes
      const innerCount = 10, outerCount = NODES.length - innerCount;
      const rInner = Math.min(w,h) * 0.18;
      const rOuter = Math.min(w,h) * 0.36;
      return NODES.map((n,i) => {
        let r, count, idx;
        if (i < innerCount) { r = rInner; count = innerCount; idx = i; }
        else { r = rOuter; count = outerCount; idx = i - innerCount; }
        const a = -Math.PI/2 + (idx * 2 * Math.PI) / count;
        return { ...n, x: cx + r*Math.cos(a), y: cy + r*Math.sin(a) };
      });
    }

    function drawNetwork() {
      const pos = getPositions();
      const links = document.getElementById("links-layer");
      const nodes = document.getElementById("nodes-layer");
      links.innerHTML = ""; nodes.innerHTML = "";

      // Links — connect each node to its 3 nearest neighbors to avoid clutter
      for (let i = 0; i < pos.length; i++) {
        const dists = pos.map((p, j) => ({ j, d: Math.hypot(p.x - pos[i].x, p.y - pos[i].y) }))
          .filter(d => d.j !== i).sort((a, b) => a.d - b.d).slice(0, 3);
        dists.forEach(({ j }) => {
          if (j < i) return; // avoid duplicate lines
          const a = pos[i], b = pos[j];
          const bothOnline = (nodesState[a.id]?.online) && (nodesState[b.id]?.online);
          const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
          line.setAttribute("x1",a.x); line.setAttribute("y1",a.y);
          line.setAttribute("x2",b.x); line.setAttribute("y2",b.y);
          line.setAttribute("stroke", bothOnline ? "#6366f1" : "#ef4444");
          line.setAttribute("stroke-opacity", bothOnline ? "0.2" : "0.08");
          line.setAttribute("stroke-width", bothOnline ? "1.5" : "1");
          line.setAttribute("stroke-dasharray", "4,3");
          links.appendChild(line);
        });
      }

      // Nodes
      pos.forEach(n => {
        const s = nodesState[n.id] || {};
        const online = s.online ?? false;
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.setAttribute("transform", `translate(${n.x},${n.y})`);
        g.style.cursor = "pointer";
        g.addEventListener("click", () => {
          if (s.chain?.length) showBlockDetail(s.chain[s.chain.length-1], n.name);
        });

        // Pulse ring
        if (online) {
          const ring = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          ring.setAttribute("r","22"); ring.setAttribute("fill","none");
          ring.setAttribute("stroke", n.color); ring.setAttribute("stroke-width","1"); ring.setAttribute("opacity","0.3");
          ring.classList.add("ping-ring"); g.appendChild(ring);
        }

        // Outer ring
        const outer = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        outer.setAttribute("r","18"); outer.setAttribute("fill", online ? "#0f172a" : "#1e1b2e");
        outer.setAttribute("stroke", online ? n.color : "#ef4444");
        outer.setAttribute("stroke-width", online ? "2" : "1.5");
        outer.setAttribute("filter","url(#glow)"); g.appendChild(outer);

        // Status dot
        const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        dot.setAttribute("r","3"); dot.setAttribute("cy","-10");
        dot.setAttribute("fill", online ? "#22c55e" : "#ef4444"); g.appendChild(dot);

        // Name
        const name = document.createElementNS("http://www.w3.org/2000/svg", "text");
        name.setAttribute("text-anchor","middle"); name.setAttribute("dy","1");
        name.setAttribute("fill","#e2e8f0"); name.setAttribute("font-size","7"); name.setAttribute("font-weight","600");
        name.setAttribute("font-family","'JetBrains Mono', monospace");
        name.textContent = `N${parseInt(n.name.split(' ')[1])}`; g.appendChild(name);

        // Chain length
        const sub = document.createElementNS("http://www.w3.org/2000/svg", "text");
        sub.setAttribute("text-anchor","middle"); sub.setAttribute("dy","10");
        sub.setAttribute("fill","#64748b"); sub.setAttribute("font-size","6");
        sub.setAttribute("font-family","'JetBrains Mono', monospace");
        sub.textContent = `${s.chainLength ?? 0} blk`; g.appendChild(sub);

        nodes.appendChild(g);
      });
    }

    // =====================================================================
    // PARTICLES
    // =====================================================================
    function spawnParticle(fromId, toId) {
      const pos = getPositions();
      const from = pos.find(p=>p.id===fromId), to = pos.find(p=>p.id===toId);
      if (!from || !to) return;
      const layer = document.getElementById("particles-layer");
      const p = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      p.setAttribute("r","3"); p.setAttribute("fill","#fbbf24"); p.setAttribute("filter","url(#glow-strong)");
      const trail = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      trail.setAttribute("r","5"); trail.setAttribute("fill","#fbbf24"); trail.setAttribute("opacity","0.15");
      layer.appendChild(trail); layer.appendChild(p);
      const dur = 1200, t0 = performance.now();
      (function anim(now) {
        const t = Math.min((now-t0)/dur, 1);
        const e = t<0.5 ? 2*t*t : -1+(4-2*t)*t;
        const x = from.x+(to.x-from.x)*e, y = from.y+(to.y-from.y)*e;
        p.setAttribute("cx",x); p.setAttribute("cy",y);
        trail.setAttribute("cx",x); trail.setAttribute("cy",y);
        const op = t<0.1 ? t*10 : t>0.9 ? (1-t)*10 : 1;
        p.setAttribute("opacity", op); trail.setAttribute("opacity", op*0.15);
        if (t < 1) requestAnimationFrame(anim);
        else { layer.removeChild(p); layer.removeChild(trail); }
      })(performance.now());
    }
    function drainParticles() {
      if (!particleQueue.length) return;
      const batch = particleQueue.splice(0, 4);
      batch.forEach((p,i) => setTimeout(() => spawnParticle(p.from, p.to), i * 250));
    }

    // =====================================================================
    // FEEDS
    // =====================================================================
    function addTx(tx, nodeName, blockIdx) {
      const feed = document.getElementById("tab-transactions");
      if (feed.querySelector("p.text-slate-600")) feed.innerHTML = "";
      const coin = tx.sender === "MINING_REWARD";
      const el = document.createElement("div");
      el.className = "slide-in bg-slate-900/50 border border-slate-800/40 rounded-lg px-3 py-2 cursor-pointer hover:bg-slate-800/40 transition";
      el.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="text-[10px] uppercase tracking-wider ${coin?'text-emerald-500':'text-amber-500'} font-semibold">${coin?'Mining Reward':'Transfer'}</span>
          <span class="text-[10px] text-slate-600">Block #${blockIdx} &middot; ${nodeName}</span>
        </div>
        <div class="flex items-center gap-2 text-xs">
          <span class="mono text-slate-400">${coin ? 'COINBASE' : truncAddr(tx.sender)}</span>
          <svg class="w-3.5 h-3.5 text-slate-600 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
          <span class="mono text-slate-300">${truncAddr(tx.recipient)}</span>
          <span class="ml-auto font-semibold mono ${coin?'text-emerald-400':'text-amber-400'}">+${tx.amount} ATL</span>
        </div>`;
      feed.insertBefore(el, feed.firstChild);
      while (feed.children.length > 80) feed.removeChild(feed.lastChild);
      // Track addresses
      if (tx.recipient) knownAddresses.add(tx.recipient);
      if (tx.sender && tx.sender !== "MINING_REWARD") knownAddresses.add(tx.sender);
    }

    function addBlock(block, nodeName, nodeIdx) {
      const feed = document.getElementById("tab-blocks");
      if (feed.querySelector("p.text-slate-600")) feed.innerHTML = "";
      const el = document.createElement("div");
      el.className = "slide-in bg-slate-900/50 border border-slate-800/40 rounded-lg px-3 py-2 cursor-pointer hover:bg-slate-800/40 transition";
      el.onclick = () => showBlockDetail(block, nodeName);
      el.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="text-sm font-bold mono text-indigo-400">#${block.index}</span>
          <span class="text-[10px] text-slate-600">${nodeName} &middot; ${new Date(block.timestamp*1000).toLocaleTimeString()}</span>
        </div>
        <div class="flex items-center gap-4 text-[10px] text-slate-400">
          <span>Proof: <span class="mono text-slate-300">${block.proof}</span></span>
          <span>TXs: <span class="mono text-slate-300">${block.transactions.length}</span></span>
          <span class="truncate flex-1">Hash: <span class="mono text-slate-300">${block.previous_hash.slice(0,16)}...</span></span>
        </div>`;
      feed.insertBefore(el, feed.firstChild);
      while (feed.children.length > 80) feed.removeChild(feed.lastChild);
    }

    // =====================================================================
    // SPARKLINE
    // =====================================================================
    function renderSparkline() {
      const el = document.getElementById("sparkline");
      const data = sparklineData.slice(-20);
      if (data.length === 0) { el.innerHTML = '<span class="text-[10px] text-slate-600">No data</span>'; return; }
      const max = Math.max(...data, 1);
      el.innerHTML = data.map(v => {
        const h = Math.max(2, (v / max) * 36);
        const color = v > 0 ? 'bg-indigo-500' : 'bg-slate-700';
        return `<div class="sparkline-bar w-[6px] ${color} rounded-sm" style="height:${h}px" title="${v} txs"></div>`;
      }).join("");
    }

    // =====================================================================
    // CHAIN COMPARISON
    // =====================================================================
    function renderChainCompare() {
      const container = document.getElementById("chain-compare");
      const maxLen = Math.max(...NODES.map(n => nodesState[n.id]?.chainLength || 0), 1);
      container.innerHTML = NODES.map(n => {
        const s = nodesState[n.id] || {};
        const len = s.chainLength || 0;
        const pct = (len / maxLen) * 100;
        const online = s.online ?? false;
        return `
          <div class="bg-slate-900/50 rounded-lg p-2 border border-slate-800/40">
            <div class="flex items-center justify-between mb-1">
              <span class="text-[10px] font-medium">${n.name}</span>
              <span class="text-[10px] mono ${online ? 'text-green-400':'text-red-400'}">${len} blk</span>
            </div>
            <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden">
              <div class="h-full rounded-full transition-all duration-500" style="width:${pct}%; background:${n.color}"></div>
            </div>
          </div>`;
      }).join("");
    }

    // =====================================================================
    // NODE CARDS
    // =====================================================================
    function renderNodeCards() {
      const container = document.getElementById("node-cards");
      container.innerHTML = NODES.map(n => {
        const s = nodesState[n.id] || {};
        const online = s.online ?? false;
        const txCount = (s.chain || []).reduce((sum,b) => sum + b.transactions.length, 0);
        return `
          <div class="flex items-center gap-2 bg-slate-900/40 rounded-lg px-2.5 py-1.5 border border-slate-800/60 ${online ? '' : 'opacity-50'}">
            <span class="w-2 h-2 rounded-full ${online?'bg-green-500':'bg-red-500'} shrink-0"></span>
            <span class="text-xs font-medium flex-1">${n.name}</span>
            <span class="text-[10px] mono text-slate-500">${s.chainLength??0} blk</span>
            <span class="text-[10px] mono text-slate-500">${txCount} tx</span>
            <span class="text-[10px] mono font-semibold ${online?'text-green-400':'text-red-400'}">${online?'UP':'DOWN'}</span>
          </div>`;
      }).join("");
    }

    // =====================================================================
    // POLLING
    // =====================================================================
    async function fetchNode(node) {
      try {
        const [hRes, cRes] = await Promise.all([
          fetch(`${node.api}/health`, { signal: AbortSignal.timeout(3000) }),
          fetch(`${node.api}/chain`, { signal: AbortSignal.timeout(3000) }),
        ]);
        if (!hRes.ok || !cRes.ok) throw 0;
        const h = await hRes.json(), c = await cRes.json();
        return { online: true, chainLength: h.chain_length, nodeId: h.node_id, chain: c.chain };
      } catch { return { online: false, chainLength: 0, nodeId: null, chain: [] }; }
    }

    async function poll() {
      pollCount++;
      const results = await Promise.all(NODES.map(n => fetchNode(n)));
      let totalBlocks = 0, totalTxs = 0, totalTokens = 0, onlineCount = 0;
      const chainLengths = [];

      results.forEach((res, i) => {
        const nid = NODES[i].id;
        nodesState[nid] = res;
        if (res.online) onlineCount++;
        chainLengths.push(res.chainLength);
        totalBlocks = Math.max(totalBlocks, res.chainLength);

        // Detect new blocks
        const prev = prevChains[nid]?.length ?? 0;
        if (res.chain.length > prev) {
          const fresh = res.chain.slice(prev);
          fresh.forEach(block => {
            addBlock(block, NODES[i].name, i);
            logEvent(`New block #${block.index} on ${NODES[i].name} (proof=${block.proof}, ${block.transactions.length} txs)`, "success");
            blockTimestamps.push(block.timestamp);
            sparklineData.push(block.transactions.length);
            block.transactions.forEach(tx => {
              addTx(tx, NODES[i].name, block.index);
              const others = NODES.filter((_,j) => j !== i);
              const target = others[Math.floor(Math.random() * others.length)];
              particleQueue.push({ from: nid, to: target.id });
            });
          });
        }
        prevChains[nid] = res.chain;

        // Totals
        res.chain.forEach(b => b.transactions.forEach(tx => {
          totalTxs++;
          if (tx.sender === "MINING_REWARD") totalTokens += tx.amount;
        }));
      });

      // Stats
      document.getElementById("stat-nodes").textContent = `${onlineCount}/${NODES.length}`;
      document.getElementById("stat-blocks").textContent = totalBlocks;
      document.getElementById("stat-txs").textContent = totalTxs;
      document.getElementById("stat-tokens").textContent = totalTokens.toFixed(1);

      // Avg block time
      const ts = blockTimestamps.slice(-20).sort();
      if (ts.length >= 2) {
        const diffs = []; for (let i=1;i<ts.length;i++) diffs.push(ts[i]-ts[i-1]);
        const avg = diffs.reduce((a,b)=>a+b,0) / diffs.length;
        document.getElementById("stat-blocktime").textContent = avg > 0 ? `${avg.toFixed(1)}s` : "--";
      }

      // TPS
      txCountHistory.push({ time: Date.now(), count: totalTxs });
      if (txCountHistory.length > 1) {
        const recent = txCountHistory.slice(-10);
        const dt = (recent[recent.length-1].time - recent[0].time) / 1000;
        const dc = recent[recent.length-1].count - recent[0].count;
        document.getElementById("stat-tps").textContent = dt > 0 ? (dc/dt).toFixed(2) : "0.0";
      }
      while (txCountHistory.length > 60) txCountHistory.shift();

      // Fetch stats from first online node
      fetchStats();

      // Connection status
      const connDot = document.getElementById("conn-dot");
      const connText = document.getElementById("connection-status");
      connDot.className = `w-2 h-2 rounded-full ${onlineCount > 0 ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`;
      connText.textContent = onlineCount > 0 ? `Connected (poll #${pollCount})` : "Disconnected";
      document.getElementById("last-poll").textContent = `Last: ${new Date().toLocaleTimeString()}`;

      drawNetwork();
      renderNodeCards();
      renderChainCompare();
      renderSparkline();
      renderKnownAddresses();
      drainParticles();
    }

    // =====================================================================
    // NODE DROPDOWNS (populate all modal node selects)
    // =====================================================================
    function populateNodeDropdowns() {
      const selects = ["wallet-node", "transfer-node", "faucet-node", "balance-node"];
      selects.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = NODES.map((n, i) => `<option value="${i}">${n.name}</option>`).join("");
      });
      // Mine buttons
      const mineContainer = document.getElementById("mine-buttons");
      if (mineContainer) {
        mineContainer.innerHTML = NODES.map((n, i) =>
          `<button onclick="mineOn(${i})" class="btn btn-success text-[10px]">${n.name}</button>`
        ).join("") + `<button onclick="mineOnAll()" class="col-span-4 btn btn-primary">Mine on ALL nodes</button>`;
      }
    }
    populateNodeDropdowns();

    // =====================================================================
    // WALLET FUNCTIONS
    // =====================================================================
    async function createWallet() {
      const nodeIdx = parseInt(document.getElementById("wallet-node").value);
      const label = document.getElementById("wallet-label").value.trim();
      const el = document.getElementById("wallet-create-result");
      el.innerHTML = '<span class="text-slate-500">Creating wallet...</span>';
      try {
        const res = await fetch(`${NODES[nodeIdx].api}/wallet/create`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ label }),
          signal: AbortSignal.timeout(5000),
        });
        const data = await res.json();
        el.innerHTML = `<div class="bg-slate-800 rounded-lg p-2 border border-emerald-800/40">
          <p class="text-emerald-400 text-[10px] mb-1">Wallet created!</p>
          <p class="text-[10px] text-slate-500">Address:</p>
          <p class="text-xs text-slate-200 break-all mb-1">${data.address}</p>
          <p class="text-[10px] text-slate-500">Private Key (save this!):</p>
          <p class="text-[10px] text-amber-400 break-all">${data.private_key}</p>
        </div>`;
        logEvent(`Wallet created on ${NODES[nodeIdx].name}: ${truncAddr(data.address)}`, "success");
        document.getElementById("wallet-label").value = "";
        refreshWalletList();
      } catch (e) {
        el.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
      }
    }

    async function refreshWalletList() {
      const nodeIdx = parseInt(document.getElementById("wallet-node").value);
      const el = document.getElementById("wallet-list");
      el.innerHTML = '<p class="text-xs text-slate-500 text-center py-2">Loading...</p>';
      try {
        const res = await fetch(`${NODES[nodeIdx].api}/wallets`, { signal: AbortSignal.timeout(5000) });
        const data = await res.json();
        if (data.wallets.length === 0) {
          el.innerHTML = '<p class="text-xs text-slate-600 text-center py-4">No wallets on this node yet</p>';
          return;
        }
        el.innerHTML = data.wallets.map(w => `
          <div class="bg-slate-800/60 rounded-lg p-2.5 border border-slate-800">
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs font-medium text-slate-300">${w.label || 'Unnamed'}</span>
              <span class="text-sm font-bold mono text-emerald-400">${w.balance.toFixed(2)} ATL</span>
            </div>
            <p class="text-[10px] mono text-slate-500 break-all">${w.address}</p>
          </div>
        `).join("");
      } catch (e) {
        el.innerHTML = `<p class="text-xs text-red-400 text-center py-2">Error: ${e.message}</p>`;
      }
    }

    // =====================================================================
    // TRANSFER FUNCTIONS
    // =====================================================================
    async function loadTransferWallets() {
      const nodeIdx = parseInt(document.getElementById("transfer-node").value);
      const el = document.getElementById("transfer-from");
      el.innerHTML = '<option value="">Loading wallets...</option>';
      try {
        const res = await fetch(`${NODES[nodeIdx].api}/wallets`, { signal: AbortSignal.timeout(5000) });
        const data = await res.json();
        if (data.wallets.length === 0) {
          el.innerHTML = '<option value="">No wallets — create one first</option>';
          return;
        }
        el.innerHTML = '<option value="">Select a wallet...</option>' +
          data.wallets.map(w => `<option value="${w.address}">${w.label || truncAddr(w.address)} (${w.balance.toFixed(2)} ATL)</option>`).join("");
      } catch (e) {
        el.innerHTML = '<option value="">Error loading wallets</option>';
      }
    }

    async function executeTransfer() {
      const nodeIdx = parseInt(document.getElementById("transfer-node").value);
      const from = document.getElementById("transfer-from").value;
      const to = document.getElementById("transfer-to").value.trim();
      const amount = parseFloat(document.getElementById("transfer-amount").value);
      const el = document.getElementById("transfer-result");

      if (!from || !to || !amount) {
        el.innerHTML = '<span class="text-red-400">All fields are required</span>';
        return;
      }

      el.innerHTML = '<span class="text-slate-500">Sending transfer & mining block...</span>';
      try {
        const res = await fetch(`${NODES[nodeIdx].api}/transfer`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ from_address: from, to_address: to, amount }),
          signal: AbortSignal.timeout(120000),
        });
        const data = await res.json();
        if (!res.ok) {
          el.innerHTML = `<span class="text-red-400">${data.error}</span>`;
          return;
        }
        el.innerHTML = `<div class="bg-slate-800 rounded-lg p-2 border border-emerald-800/40">
          <p class="text-emerald-400 text-[10px]">Transfer confirmed in block #${data.block_index}</p>
          <p class="text-[10px] text-slate-400">${truncAddr(data.from)} → ${truncAddr(data.to)}: ${data.amount} ATL</p>
        </div>`;
        logEvent(`Transfer: ${truncAddr(from)} → ${truncAddr(to)} (${amount} ATL) — block #${data.block_index}`, "success");
        poll();
        loadTransferWallets();
      } catch (e) {
        el.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
      }
    }

    // =====================================================================
    // FAUCET FUNCTIONS
    // =====================================================================
    async function loadFaucetAddresses() {
      const nodeIdx = parseInt(document.getElementById("faucet-node").value);
      const el = document.getElementById("faucet-known");
      el.innerHTML = '<option value="">-- Pick from known wallets --</option>';
      try {
        const res = await fetch(`${NODES[nodeIdx].api}/wallets`, { signal: AbortSignal.timeout(5000) });
        const data = await res.json();
        data.wallets.forEach(w => {
          el.innerHTML += `<option value="${w.address}">${w.label || truncAddr(w.address)} (${w.balance.toFixed(2)} ATL)</option>`;
        });
      } catch {}
    }

    // Sync faucet-known dropdown to faucet-address input
    document.getElementById("faucet-known").addEventListener("change", function() {
      if (this.value) document.getElementById("faucet-address").value = this.value;
    });

    async function requestFaucet() {
      const nodeIdx = parseInt(document.getElementById("faucet-node").value);
      const address = document.getElementById("faucet-address").value.trim();
      const amount = parseFloat(document.getElementById("faucet-amount").value);
      const el = document.getElementById("faucet-result");

      if (!address) {
        el.innerHTML = '<span class="text-red-400">Address is required</span>';
        return;
      }

      el.innerHTML = '<span class="text-slate-500">Requesting tokens & mining block...</span>';
      try {
        const res = await fetch(`${NODES[nodeIdx].api}/faucet`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ address, amount }),
          signal: AbortSignal.timeout(120000),
        });
        const data = await res.json();
        if (!res.ok) {
          el.innerHTML = `<span class="text-red-400">${data.error}</span>`;
          return;
        }
        el.innerHTML = `<div class="bg-slate-800 rounded-lg p-2 border border-emerald-800/40">
          <p class="text-emerald-400 text-[10px]">Faucet delivered ${data.amount} ATL in block #${data.block_index}</p>
          <p class="text-[10px] text-slate-400">New balance: <span class="text-emerald-400 font-bold">${data.new_balance} ATL</span></p>
        </div>`;
        logEvent(`Faucet: ${data.amount} ATL → ${truncAddr(address)} — block #${data.block_index}`, "success");
        poll();
      } catch (e) {
        el.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
      }
    }

    // =====================================================================
    // STATS FETCH
    // =====================================================================
    async function fetchStats() {
      // Find first online node
      const onlineIdx = NODES.findIndex(n => nodesState[n.id]?.online);
      if (onlineIdx === -1) {
        document.getElementById("stat-addresses").textContent = "0";
        document.getElementById("stat-supply").textContent = "0.0";
        return;
      }
      try {
        const res = await fetch(`${NODES[onlineIdx].api}/stats`, { signal: AbortSignal.timeout(5000) });
        const data = await res.json();
        document.getElementById("stat-addresses").textContent = data.circulating_addresses;
        document.getElementById("stat-supply").textContent = data.total_supply.toFixed(1);
      } catch {}
    }

    // =====================================================================
    // CONSENSUS FUNCTIONS
    // =====================================================================
    async function loadConsensusInfo() {
      const onlineIdx = NODES.findIndex(n => nodesState[n.id]?.online);
      if (onlineIdx === -1) return;
      try {
        const res = await fetch(`${NODES[onlineIdx].api}/consensus`, { signal: AbortSignal.timeout(5000) });
        const data = await res.json();
        const el = document.getElementById("consensus-info");
        el.innerHTML = Object.entries(data).map(([k,v]) =>
          `<div class="flex justify-between py-0.5"><span class="text-slate-500">${k}:</span><span class="text-slate-200">${typeof v === 'object' ? JSON.stringify(v).slice(0,60) : v}</span></div>`
        ).join("");
      } catch {}
    }
    async function switchConsensus(engine) {
      const onlineIdx = NODES.findIndex(n => nodesState[n.id]?.online);
      if (onlineIdx === -1) return;
      const el = document.getElementById("consensus-result");
      el.innerHTML = `<span class="text-slate-500">Switching to ${engine}...</span>`;
      try {
        const res = await fetch(`/consensus/switch`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ engine }),
          signal: AbortSignal.timeout(5000),
        });
        const data = await res.json();
        el.innerHTML = `<span class="text-emerald-400">Switched to ${data.engine || engine}</span>`;
        logEvent(`Consensus switched to ${engine}`, "success");
        loadConsensusInfo();
      } catch (e) {
        el.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
      }
    }

    // =====================================================================
    // CONTRACT FUNCTIONS
    // =====================================================================
    async function deployContract() {
      const owner = document.getElementById("contract-owner").value.trim();
      const template = document.getElementById("contract-template").value;
      const el = document.getElementById("contract-deploy-result");
      if (!owner) { el.innerHTML = '<span class="text-red-400">Owner address required</span>'; return; }
      el.innerHTML = '<span class="text-slate-500">Deploying...</span>';
      try {
        const res = await fetch("/contract/deploy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ owner, template }),
          signal: AbortSignal.timeout(10000),
        });
        const data = await res.json();
        if (!res.ok) { el.innerHTML = `<span class="text-red-400">${data.error}</span>`; return; }
        el.innerHTML = `<span class="text-emerald-400">Deployed: ${data.address}</span>`;
        logEvent(`Contract deployed: ${truncAddr(data.address)} by ${truncAddr(owner)}`, "success");
        loadContracts();
      } catch (e) { el.innerHTML = `<span class="text-red-400">${e.message}</span>`; }
    }
    async function loadContracts() {
      const el = document.getElementById("contract-list");
      try {
        const res = await fetch("/contracts", { signal: AbortSignal.timeout(5000) });
        const data = await res.json();
        if (!data.contracts || data.contracts.length === 0) {
          el.innerHTML = '<p class="text-xs text-slate-600 text-center py-4">No contracts deployed</p>';
          return;
        }
        el.innerHTML = data.contracts.map(c => `
          <div class="bg-slate-800/60 rounded-lg p-2.5 border border-slate-800">
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs font-medium text-slate-300">${c.label || 'Contract'}</span>
              <span class="text-[10px] mono text-slate-500">${new Date(c.created_at*1000).toLocaleTimeString()}</span>
            </div>
            <p class="text-[10px] mono text-indigo-400 break-all">${c.address}</p>
            <p class="text-[10px] mono text-slate-600">Owner: ${truncAddr(c.owner)}</p>
          </div>
        `).join("");
      } catch (e) { el.innerHTML = `<p class="text-xs text-red-400">${e.message}</p>`; }
    }

    // =====================================================================
    // STAKING FUNCTIONS
    // =====================================================================
    async function doStake() {
      const address = document.getElementById("stake-address").value.trim();
      const amount = parseFloat(document.getElementById("stake-amount").value);
      const el = document.getElementById("stake-result");
      if (!address || !amount) { el.innerHTML = '<span class="text-red-400">Address and amount required</span>'; return; }
      el.innerHTML = '<span class="text-slate-500">Staking...</span>';
      try {
        const res = await fetch("/stake", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ address, amount }), signal: AbortSignal.timeout(5000),
        });
        const data = await res.json();
        if (!res.ok) { el.innerHTML = `<span class="text-red-400">${data.error}</span>`; return; }
        el.innerHTML = `<span class="text-emerald-400">Staked ${data.amount} ATL from ${truncAddr(data.address)}</span>`;
        logEvent(`Staked ${data.amount} ATL from ${truncAddr(address)}`, "success");
        loadStakes();
      } catch (e) { el.innerHTML = `<span class="text-red-400">${e.message}</span>`; }
    }
    async function doUnstake() {
      const address = document.getElementById("stake-address").value.trim();
      const el = document.getElementById("stake-result");
      if (!address) { el.innerHTML = '<span class="text-red-400">Address required</span>'; return; }
      el.innerHTML = '<span class="text-slate-500">Unstaking...</span>';
      try {
        const res = await fetch("/unstake", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ address }), signal: AbortSignal.timeout(5000),
        });
        const data = await res.json();
        if (!res.ok) { el.innerHTML = `<span class="text-red-400">${data.error}</span>`; return; }
        el.innerHTML = `<span class="text-emerald-400">Unstaked ${data.returned} ATL to ${truncAddr(address)}</span>`;
        logEvent(`Unstaked from ${truncAddr(address)}`, "success");
        loadStakes();
      } catch (e) { el.innerHTML = `<span class="text-red-400">${e.message}</span>`; }
    }
    async function loadStakes() {
      const el = document.getElementById("stake-list");
      try {
        const res = await fetch("/stakes", { signal: AbortSignal.timeout(5000) });
        const data = await res.json();
        if (!data.stakes || data.stakes.length === 0) {
          el.innerHTML = '<p class="text-xs text-slate-600 text-center py-4">No active stakes</p>';
          return;
        }
        el.innerHTML = data.stakes.map(s => `
          <div class="bg-slate-800/60 rounded-lg p-2.5 border border-slate-800 flex items-center justify-between">
            <span class="text-[10px] mono text-slate-400">${truncAddr(s.address)}</span>
            <span class="text-sm font-bold mono text-emerald-400">${s.amount} ATL</span>
          </div>`).join("");
      } catch (e) { el.innerHTML = `<p class="text-xs text-red-400">${e.message}</p>`; }
    }

    // =====================================================================
    // SIMULATION FUNCTIONS
    // =====================================================================
    async function runSimulation(type) {
      const el = document.getElementById("sim-result");
      el.textContent = `Running ${type} simulation...`;
      logEvent(`Simulation started: ${type}`, "warn");
      try {
        const res = await fetch(`/simulate/${type}`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({}), signal: AbortSignal.timeout(30000),
        });
        const data = await res.json();
        el.textContent = JSON.stringify(data, null, 2);
        logEvent(`Simulation ${type} completed`, "success");
        poll();
      } catch (e) {
        el.textContent = `Error: ${e.message}`;
        logEvent(`Simulation ${type} failed: ${e.message}`, "error");
      }
    }

    // =====================================================================
    // SSE REAL-TIME EVENTS
    // =====================================================================
    function connectSSE() {
      try {
        const source = new EventSource("/events");
        source.onmessage = function(event) {
          try {
            const data = JSON.parse(event.data);
            if (data.type === "new_block") {
              logEvent(`[SSE] New block #${data.data?.index || '?'} mined`, "success");
              poll();
            } else if (data.type === "new_transaction") {
              logEvent(`[SSE] New transaction: ${truncAddr(data.data?.sender)} → ${truncAddr(data.data?.recipient)}`, "info");
            } else if (data.type === "consensus_change") {
              logEvent(`[SSE] Consensus changed to ${data.data?.engine || '?'}`, "warn");
              loadConsensusInfo();
            } else {
              logEvent(`[SSE] ${data.type}: ${JSON.stringify(data.data).slice(0, 80)}`, "info");
            }
          } catch {}
        };
        source.onerror = function() {
          source.close();
          setTimeout(connectSSE, 5000);
        };
      } catch {}
    }

    // =====================================================================
    // INIT
    // =====================================================================
    drawNetwork();
    poll();
    setInterval(poll, POLL_MS);
    window.addEventListener("resize", drawNetwork);
    connectSSE();
    logEvent("Atlas Network Monitor v2.0 initialized", "info");
  </script>
</body>
</html>
